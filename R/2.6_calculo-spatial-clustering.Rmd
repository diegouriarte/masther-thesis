---
title: "Cálculo de spatial clustering"
output: html_notebook
---

Cargamos librerías 

```{r}
suppressMessages(library(tidyverse))
```

Cargamos dataset con grifos y vecinos

```{r}
grifos <- readRDS(here::here("data","processed","grifo_con_vecinos.rds"))

glimpse(grifos)
```

Tomemos un grifo cercano a mi casa y conocido para ver:

```{r}
grifos %>%
    filter(razon_social.princ == "INVERSIONES MAVU S.A.C.") %>%
    select(
        codigo_de_osinergmin.princ,
        razon_social.princ,
        bandera.princ,
        codigo_de_osinergmin.vec,
        razon_social.vec,
        bandera.vec
    )
```


Obtenemos las razones sociales de los vecinos:

```{r}
grifos %>%
    filter(razon_social.princ == "INVERSIONES MAVU S.A.C.") %>%
    pull(razon_social.vec)
```

Calculemos el tamaño del mercado:

```{r}
N <- grifos %>%
    filter(razon_social.princ == "INVERSIONES MAVU S.A.C.") %>%
    select(razon_social.princ,
           bandera.princ,
           razon_social.vec,
           bandera.vec) %>%
    nrow() + 1

N

```

Saquemos cuantos grifos independientes hay:

```{r}
vec_ind <- grifos %>%
    filter(razon_social.princ == "INVERSIONES MAVU S.A.C.") %>%
    filter(bandera.vec == "INDEPENDIENTE") %>%
    distinct(codigo_de_osinergmin.vec) %>%
    nrow()

grifo_band <- grifos %>%
    filter(razon_social.princ == "INVERSIONES MAVU S.A.C.") %>%
    distinct(bandera.princ) %>%
    pull()
clust_ind <- vec_ind + if_else(grifo_band == "INDEPENDIENTE", 1, 0)
clust_ind
```
Ya tenemos los tres clúster independientes. Ahora, saquemos los clusteres que no son vecinos:

```{r}
grifos_no_indp <- grifos %>%
    filter(razon_social.princ == "INVERSIONES MAVU S.A.C.") %>%
    select(razon_social.princ,
           bandera.princ,
           razon_social.vec,
           codigo_de_osinergmin.vec,
           bandera.vec) %>%
    filter(bandera.vec != "INDEPENDIENTE") %>%
    pull(codigo_de_osinergmin.vec)

grifos_no_indp
```


Con ese grifo, veamos si tiene vecinos de su mismo tipo:

```{r}
 grifos_vecinos <- grifos %>%
    filter(codigo_de_osinergmin.princ == grifos_no_indp[1]) %>%
    pull(bandera.vec)

grifos_vecinos

grifo_vec_bandera <- unique(grifos[grifos$codigo_de_osinergmin.princ == grifos_no_indp[1],]$bandera.princ) 

```
## Funciones

Escribiremos las funciones que necesitamos:

```{r}
grifos %>% filter(codigo_de_osinergmin.princ == 14665) %>%
    select(codigo_de_osinergmin.vec, razon_social.vec, bandera.vec)
```



```{r}

hallar_bandera <- function(cod1) {
    grifos %>% 
        filter(codigo_de_osinergmin.princ == cod1) %>%
        distinct(bandera.princ) %>% 
        pull()
}

hallar_lista_vecinos <- function(cod1) {
    grifos[grifos$codigo_de_osinergmin.princ == cod1, ]$codigo_de_osinergmin.vec
}


indicar_vecinos <- function(cod1, cod2) {
    if (cod2 %in% hallar_lista_vecinos(cod1)) {
        return(1)
    }
    0
}



hallar_g_marca <- function(cod1){
    #función que retorne los grifos de marca vecinos a la estación cod1
    marcas <- c("REPSOL", "PECSA", "PETROPERU", "PRIMAX")
    l <- vector()
    for (estacion in hallar_lista_vecinos(cod1)) {
        if (hallar_bandera(estacion) %in% marcas) {
            l <- append(l, estacion)  
        }
    }
    l
}

hallar_lista_vecinos(17947)
indicar_vecinos(14665, 17947)
indicar_vecinos(14665,6754)
hallar_lista_vecinos(14665)
hallar_g_marca(6754)
```
```{r}
grifos %>% filter(codigo_de_osinergmin.princ == 14665) %>%
    select(codigo_de_osinergmin.vec, razon_social.vec, bandera.vec)

#hallamos los grifos con alguna marca asociada:
hallar_g_marca(14665)

#El unico grifo vecino con marca es 17947 (PECSA). Revisamos que cada grifo de marca tenga vecinos de la misma marca

hallar_lista_vecinos(hallar_g_marca(14665)[1])


#Buscamos los vecinos de la misma marca:

for (grif in hallar_lista_vecinos(hallar_g_marca(14665)[1]) ) {
    list <- c()
    if (hallar_bandera(grif) == hallar_bandera(17947)) {
        list <- append(list, grif)
    }
    list
}
list
```

```{r}
grifos %>% filter(codigo_de_osinergmin.princ == 17947) %>%
    select(codigo_de_osinergmin.vec, razon_social.vec, bandera.vec)
```
```{r}
hallar_cluster <- function(cod) {
    df1 <- filter(grifos, codigo_de_osinergmin.princ == cod) %>%
        distinct(codigo_de_osinergmin.princ,
                 razon_social.princ,
                 bandera.princ)
    bandera <- hallar_bandera(cod)
    lista_vecinos <- hallar_lista_vecinos(cod)
    df2 <- filter(grifos,
           codigo_de_osinergmin.princ %in% lista_vecinos,
           bandera.princ == bandera) %>%
        distinct(codigo_de_osinergmin.princ,
                 razon_social.princ,
                 bandera.princ)
    bind_rows(df1, df2)
}

hallar_cluster(8153)

vec_bandera <- function(cod) {
    hallar_cluster(cod) %>%
        filter(codigo_de_osinergmin.princ != cod)
}

vec_bandera(8153)

hallar_cluster(9146)
hallar_cluster(8101)

bind_rows(hallar_cluster(8153), hallar_cluster(9146), hallar_cluster(8101)) %>%
    distinct() %>%
    bind_rows(hallar_cluster(8336)) %>% distinct() %>%
    bind_rows(hallar_cluster(6806)) %>% distinct() %>%
    bind_rows(hallar_cluster(14693)) %>% distinct() %>%
    bind_rows(hallar_cluster(9220)) %>% distinct() %>%
    bind_rows(hallar_cluster(18567)) %>% distinct() %>%
    bind_rows(hallar_cluster(6788)) %>% distinct() %>%
    bind_rows(hallar_cluster(16640)) %>% distinct()

i <- 1
df <- hallar_cluster(8153)

while (i < nrow(df)) {
    df <- bind_rows(df, hallar_cluster(df$codigo_de_osinergmin.princ[i+1])) %>%
    distinct() 
    i <- i + 1
}
    
df

hallar_cluster(7124)



i <- 1
df <- hallar_cluster(7177)

while (i < nrow(df)) {
    df <- bind_rows(df, hallar_cluster(df$codigo_de_osinergmin.princ[i+1])) %>%
    distinct() 
    i <- i + 1
}
    
df
```

```{r}
hallar_todos_cluster <- function(cod) {
    if (hallar_bandera(cod) == "INDEPENDIENTE") {
        df1 <- filter(grifos, codigo_de_osinergmin.princ == cod) %>%
            distinct(codigo_de_osinergmin.princ,
                     razon_social.princ,
                     bandera.princ)
        return(df1)
    }
    i <- 1
    df <- hallar_cluster(cod)
    
    while (i < nrow(df)) {
        df <-
            bind_rows(df, hallar_cluster(df$codigo_de_osinergmin.princ[i + 1])) %>%
            distinct()
        i <- i + 1
    }
    
    arrange(df, codigo_de_osinergmin.princ)
}

#cluster de 1
hallar_todos_cluster(14646)
#cluster de 2 
hallar_todos_cluster(19956)
#cluster independiente
hallar_todos_cluster(62240)


```

Hagamos el cálculo para un grifo cualquiera 19956, que tiene 9 vecinos, es de 

```{r}
df1 <- grifos %>% filter(codigo_de_osinergmin.princ == 19956) %>%
    select(codigo = codigo_de_osinergmin.princ, 
           razon_social = razon_social.princ, 
           bandera = bandera.princ) %>% distinct()
df2 <- grifos %>% filter(codigo_de_osinergmin.princ == 19956) %>%
    select(codigo = codigo_de_osinergmin.vec, 
           razon_social = razon_social.vec, 
           bandera = bandera.vec)

grifo19956 <- bind_rows(df1, df2)
#creamos lista con cluster de cada grifo (pueden haber repetidos)

lista <- list()


for (grifo in grifo19956$codigo) {
    lista[[as.character(grifo)]] <- hallar_todos_cluster(grifo)    
}
for(i in lista){print(i)}


```

```{r}
#hacemos un loop para quedarnos solo con los que no son repetidos

comprobar_df_dup <- function(df1, df2) {
    if (is.null(df1) | is.null(df2)) {
        return(FALSE)
    }
    if (nrow(df1) == nrow(df2)) {
        if (all(df1 == df2)) {
            return(TRUE)
        } else {
            return(FALSE)
        }
    } else {
        return(FALSE)
    }
}
#Prueba, debería retornar verdadero

comprobar_df_dup(hallar_todos_cluster(17944), hallar_todos_cluster(94684))

#debería retornar falso
comprobar_df_dup(hallar_todos_cluster(17944), hallar_todos_cluster(19956))

#nulo versus df
comprobar_df_dup(NULL, hallar_todos_cluster(19956))


```

```{r}
for (i in 1:(length(lista)-1)) {
    for (j in (i+1):length(lista)) {
        if(comprobar_df_dup(lista[[i]], lista[[j]])) {
            lista[j] <- list(NULL)
        }
    }
}

lista[sapply(lista, is.null)] <- NULL

for(i in lista){print(i)}

```

Vemos que funciona, así que empaquetemos en una función:

```{r}

hallar_clusteres_mercado <- function(cod) {
    df1 <- grifos %>% filter(codigo_de_osinergmin.princ == cod) %>%
        select(codigo = codigo_de_osinergmin.princ,
               razon_social = razon_social.princ,
               bandera = bandera.princ) %>% distinct()
    df2 <- grifos %>% filter(codigo_de_osinergmin.princ == cod) %>%
        select(codigo = codigo_de_osinergmin.vec,
               razon_social = razon_social.vec,
               bandera = bandera.vec)
    
    grifo_con_vecinos <- bind_rows(df1, df2)
    #creamos lista con cluster de cada grifo (pueden haber repetidos)
    
    lista <- list()
    
    for (grifo in grifo_con_vecinos$codigo) {
        lista[[as.character(grifo)]] <- hallar_todos_cluster(grifo)
    }
    
    #removemos los df repetidos (que normalmente habrá si hay vecinos en el mercado
    #del mismo cluster)
    for (i in 1:(length(lista) - 1)) {
        for (j in (i + 1):length(lista)) {
            if (comprobar_df_dup(lista[[i]], lista[[j]])) {
                lista[j] <- list(NULL)
            }
        }
    }
    
    lista[sapply(lista, is.null)] <- NULL
    lista
}

hallar_clusteres_mercado(19956)
str(hallar_clusteres_mercado(14665))

```

Ahora, hallamos la medida de spatial clustering para grifo 14665:

```{r}
#número de estaciones en el mercado (vecinos + 1)
(N <- length(hallar_lista_vecinos(14665)) + 1)
#número de clusteres
(M <- length(hallar_clusteres_mercado(14665)))
#suma número de estaciones en cada cluster
suma_clusteres <- sum(sapply(hallar_clusteres_mercado(14665), nrow))
suma_clusteres
sc <- suma_clusteres/M/N
sc

```
Ahora, hallamos la medida de spatial clustering para grifo 19956:

```{r}
#número de estaciones en el mercado (vecinos + 1)
(N <- length(hallar_lista_vecinos(14645)) + 1)
#número de clusteres
(M <- length(hallar_clusteres_mercado(14645)))
#suma número de estaciones en cada cluster
suma_clusteres <- sum(sapply(hallar_clusteres_mercado(14645), nrow))
suma_clusteres
sc <- suma_clusteres/M/N
sc

```
Empaquetamos en una función

```{r}
calcular_sc <- function(cod) {
    #numero de grifos en el mercado local
    N <- length(hallar_lista_vecinos(cod)) + 1
    #número de clusteres
    (M <- length(hallar_clusteres_mercado(cod)))
    #suma número de estaciones en cada cluster
    suma_clusteres <- sum(sapply(hallar_clusteres_mercado(cod), nrow))
    suma_clusteres
    #medida de spatial cluster 
    sc <- suma_clusteres / M / N
    sc
}

calcular_sc(19956)
calcular_sc(14645)

```

