---
title: "Análisis de diferencias en diferencias"
author: "Diego Uriarte"
date: "`r format(Sys.Date())`"
output:
  html_notebook:
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    error = TRUE,
    message = FALSE,
    warning = FALSE
)
options(tidyverse.quiet = TRUE)

```

```{r  body, warning = FALSE, message = FALSE}
library(conflicted)
library(tidyverse)
library(lubridate)
library(stargazer)
library(multiwayvcov)
library(lmtest)
source(here::here("R","funcion04_formato-tablas-reproducibles.R"), encoding = "UTF-8")
'%ni%' <- Negate('%in%')
conflict_prefer("filter", "dplyr")
```

## Cargamos datos


```{r cargar-datos}

data_total <- readRDS(file = here::here("data", "processed", "data-final-regresiones.rds"))

data_total <- data_total %>% 
  mutate(codigo_de_osinergmin = factor(codigo_de_osinergmin))
```

## Creamos variables
Con la data tipo panel debes tener una dummy que identifique cada observación (grifo-mes) acorde con si pertenece al grupo de tratamiento/control y otra para identificar si su período corresponde a antes/después de la fusión

a) variable tratamiento/control: la idea es ver el impacto de la fusión. Entonces el tratamiento debería ser algo relacionado a ser afectado por la fusión. Hay varias alternativas. Podría ser "ser un grifo del grupo fusionado Primax" o "ser un grifo colindante con un grifo que pertenece a la fusión". Diría que la 2da es más relevante, pero la 1era también es interesante. La dummy sería igual a 1 para todo grifo que pase eventualmente por el tratamiento, sea como sea que lo definas, e igual a cero para los grifos que pasen a formar parte de tu grupo de control.

b) variable timing: lo más sencillo sería una dummy = 0 para todo mes antes de la fusión, =1 para todo mes posterior. Se puede elaborar más y tener una dummy por trimestre o mes. 


Ahora especificamos modelos:

```{r}
reg_clust <- function(form, 
                      data, 
                      producto, 
                      fecha_lim = c("01-05-2017", "01-10-2018"), 
                      filtrado = FALSE){
  if (filtrado == TRUE) {
    data_filtrada <- balancear_panel(data, prod = producto) %>% 
      filter(fecha >= dmy("01-04-2018") | fecha <= dmy("01-11-2017")) %>% 
      mutate(fecha = factor(fecha)) 
  } else {
    data_filtrada <- balancear_panel(data, prod = producto, fecha_lim) %>% 
      mutate(fecha = factor(fecha))
  }

  modelo <- lm(formula = form, 
                           data = data_filtrada)  
  m1.vcovCL <- cluster.vcov(modelo,data_filtrada$codigo_de_osinergmin)
list(modelo, coeftest(modelo, m1.vcovCL))
}
```

### DiD para vecinos thiessen
```{r}
modelo_vecino <- precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did + 
  tipo_bandera + fecha + codigo_de_osinergmin

reg_clust(modelo_vecino, data_total, "DIESEL")

reg_vecino_clust <- map(c("DIESEL", "G90"), ~reg_clust(modelo_vecino, data_total, .x ))
names(reg_vecino_clust) <- c("DIESEL", "G90")
stargazer(reg_vecino_clust, 
          type = "text", 
          omit = c("tipo_ba", "fecha", "codigo"))
```

### DiD para vecinos thiessen
```{r}
modelo_vecino <- precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did + 
  tipo_bandera + fecha + codigo_de_osinergmin + ingresos_2012 + num_grifos_cerc

reg_clust(modelo_vecino, data_total, "DIESEL")

reg_vecino_clust <- map(c("DIESEL", "G90"), ~reg_clust(modelo_vecino, data_total, .x ))
names(reg_vecino_clust) <- c("DIESEL", "G90")
stargazer(reg_vecino_clust, 
          type = "text", 
          omit = c("tipo_ba", "fecha", "codigo"))
```

### DiD para vecinos distancia
```{r}
modelo_vecino_dist <- precio_de_venta ~ vecino_pecsa_dist_did * timing_did + 
  tipo_bandera + fecha + codigo_de_osinergmin

reg_vecino_did_clust <- map(c("DIESEL", "G90"), ~reg_clust(modelo_vecino_dist, data_total, .x ))
names(reg_vecino_did_clust) <- c("DIESEL", "G90")
stargazer(reg_vecino_did_clust, 
          type = "text", 
          omit = c("tipo_ba", "fecha", "codigo"))
```

### DiD para propias estaciones

Primero para el diésel con estaciones compradas

```{r}

diesel_full_sin_controles <- reg_clust(precio_de_venta ~ COMPRADA_DID * timing_did, data_total, "DIESEL")

diesel_sin3meses_ni_controles <- reg_clust(precio_de_venta ~ COMPRADA_DID * timing_did, 
                                 data_total, 
                                 "DIESEL",
                                 filtrado = TRUE)

modelo_compradas_ef <- precio_de_venta ~ COMPRADA_DID * timing_did + 
 fecha + codigo_de_osinergmin

diesel_full_con_ef <- reg_clust(modelo_compradas_ef, data_total, "DIESEL")

modelo_compradas_ef_sc <- precio_de_venta ~ COMPRADA_DID * timing_did + tipo_bandera + 
 fecha + codigo_de_osinergmin + sc 

diesel_full_ef_sc <- reg_clust(modelo_compradas_ef_sc, data_total, "DIESEL")

modelo_compradas_controles <- precio_de_venta ~ COMPRADA_DID * timing_did + tipo_bandera +
 fecha + grifo_mas_cercano + distancia_min + num_grifos_cerc +
  tiene_mecanico + densidad_2017 + ingresos_2012 + num_viajes_millon + sc + distrito
diesel_full_controls <- reg_clust(modelo_compradas_controles, data_total, "DIESEL")
stargazer(diesel_full_controls, type = "text")
lista_reg <- list(diesel_full_sin_controles, diesel_sin3meses_ni_controles,
                  diesel_full_con_ef, diesel_full_ef_sc)

t <- map(lista_reg, 2)
se <- map(lista_reg, 2) %>% 
  map(~ .[,2])

pe <- map(lista_reg, 2) %>% 
  map(~ .[,4])

stargazer(map(lista_reg, 1),
          type = "html",
          dep.var.labels=str_c("Precio de venta - Diésel (soles/galón)"),
          dep.var.caption = "",
          model.numbers	= T,
          no.space = F,
          covariate.labels = c("Dum.Comprada", "Dum.FechaCompra", "sc", 
                               "Dum.Comprada*Dum.FechaCompra", "Constante" ),
          column.labels =  "", 
          se = se,
          p = pe,
          omit = c("tipo_bandera", "fecha", "codigo_de_osinergmin"),
          omit.labels = c("Tipo de estación", "Efectos fijos por meses", "Efectos fijos por estación"),
          omit.yes.no = c("Sí", "No"),
          omit.stat	= c("f", "ll", 
                        "sigma2", "res.dev", "ser", "aic",
                        "wald", "lr"),
          notes= "Los errores estándares clusterizados por estación se muestran entre paréntesis. ",
          notes.label = "Notas: ",
          single.row = F, 
          out = here::here("doc", "tables", "diesel_did_compra.htm"))
```

### Ahora para gasohol 90 compra

```{r}

g90_full_sin_controles <- reg_clust(precio_de_venta ~ COMPRADA_DID * timing_did, data_total, "G90")

g90_sin3meses_ni_controles <- reg_clust(precio_de_venta ~ COMPRADA_DID * timing_did, 
                                 data_total, 
                                 "G90",
                                 filtrado = TRUE)

modelo_compradas_ef <- precio_de_venta ~ COMPRADA_DID * timing_did + 
 fecha + codigo_de_osinergmin

g90_full_con_ef <- reg_clust(modelo_compradas_ef, data_total, "G90")

modelo_compradas_ef_sc <- precio_de_venta ~ COMPRADA_DID * timing_did + tipo_bandera + 
 fecha + codigo_de_osinergmin + sc 

g90_full_ef_sc <- reg_clust(modelo_compradas_ef_sc, data_total, "G90")

# modelo_compradas_controles <- precio_de_venta ~ COMPRADA_DID * timing_did + tipo_bandera + 
#  fecha + grifo_mas_cercano + distancia_min + num_grifos_cerc + 
#   tiene_mecanico + densidad_2017 + ingresos_2012 + num_viajes_millon + sc
# g90_full_full_controls <- reg_clust(modelo_compradas_controles, data_total, "G90")

lista_reg <- list(g90_full_sin_controles, g90_sin3meses_ni_controles,
                  g90_full_con_ef, g90_full_ef_sc)

t <- map(lista_reg, 2)
se <- map(lista_reg, 2) %>% 
  map(~ .[,2])

pe <- map(lista_reg, 2) %>% 
  map(~ .[,4])

stargazer(map(lista_reg, 1),
          type = "html",
          dep.var.labels=str_c("Precio de venta - Gasohol 90 (soles/galón)"),
          dep.var.caption = "",
          model.numbers	= T,
          no.space = F,
          covariate.labels = c("Dum.Comprada", "Dum.FechaCompra", "sc", 
                               "Dum.Comprada*Dum.FechaCompra", "Constante" ),
          column.labels =  "", 
          se = se,
          p = pe,
          omit = c("tipo_bandera", "fecha", "codigo_de_osinergmin"),
          omit.labels = c("Tipo de estación", "Efectos fijos por meses", "Efectos fijos por estación"),
          omit.yes.no = c("Sí", "No"),
          omit.stat	= c("f", "ll", 
                        "sigma2", "res.dev", "ser", "aic",
                        "wald", "lr"),
          notes= "Los errores estándares clusterizados por estación se muestran entre paréntesis. ",
          notes.label = "Notas: ",
          single.row = F, 
          out = here::here("doc", "tables", "g90_did_compra.htm"))
```

### Para vecinos

#### Diesel

```{r}
# modelo_vecino <- precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did + 
#   tipo_bandera + fecha + codigo_de_osinergmin + ingresos_2012 + num_grifos_cerc
# 
# reg_clust(modelo_vecino, data_total, "DIESEL")
# 
# reg_vecino_clust <- map(c("DIESEL", "G90"), ~reg_clust(modelo_vecino, data_total, .x ))
# names(reg_vecino_clust) <- c("DIESEL", "G90")
# stargazer(reg_vecino_clust, 
#           type = "text", 
#           omit = c("tipo_ba", "fecha", "codigo"))

diesel_full_sin_controles <- reg_clust(precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did, data_total, "DIESEL")

diesel_sin3meses_ni_controles <- reg_clust(precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did, 
                                 data_total, 
                                 "DIESEL",
                                 filtrado = TRUE)

modelo_compradas_ef <- precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did + 
 fecha + codigo_de_osinergmin

diesel_full_con_ef <- reg_clust(modelo_compradas_ef, data_total, "DIESEL")

modelo_compradas_ef_sc <- precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did + tipo_bandera + 
 fecha + codigo_de_osinergmin + sc 

diesel_full_ef_sc <- reg_clust(modelo_compradas_ef_sc, data_total, "DIESEL")

# modelo_compradas_controles <- precio_de_venta ~ COMPRADA_DID * timing_did + tipo_bandera + 
#  fecha + grifo_mas_cercano + distancia_min + num_grifos_cerc + 
#   tiene_mecanico + densidad_2017 + ingresos_2012 + num_viajes_millon + sc
# diesel_full_full_controls <- reg_clust(modelo_compradas_controles, data_total, "DIESEL")

lista_reg <- list(diesel_full_sin_controles, diesel_sin3meses_ni_controles,
                  diesel_full_con_ef, diesel_full_ef_sc)

t <- map(lista_reg, 2)
se <- map(lista_reg, 2) %>% 
  map(~ .[,2])

pe <- map(lista_reg, 2) %>% 
  map(~ .[,4])

stargazer(map(lista_reg, 1),
          type = "html",
          dep.var.labels=str_c("Precio de venta - Diésel (soles/galón)"),
          dep.var.caption = "",
          model.numbers	= T,
          no.space = F,
          covariate.labels = c("Dum.Vecino", "Dum.FechaCompra", "sc", 
                               "Dum.Vecino*Dum.FechaCompra", "Constante" ),
          column.labels =  "", 
          se = se,
          p = pe,
          omit = c("tipo_bandera", "fecha", "codigo_de_osinergmin"),
          omit.labels = c("Tipo de estación", "Efectos fijos por meses", "Efectos fijos por estación"),
          omit.yes.no = c("Sí", "No"),
          omit.stat	= c("f", "ll", 
                        "sigma2", "res.dev", "ser", "aic",
                        "wald", "lr"),
          notes= "Los errores estándares clusterizados por estación se muestran entre paréntesis. ",
          notes.label = "Notas: ",
          single.row = F, 
          out = here::here("doc", "tables", "diesel_did_vecino.htm"))
```

#### Gasohol 90

```{r}

g90_full_sin_controles <- reg_clust(precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did, data_total, "G90")

g90_sin3meses_ni_controles <- reg_clust(precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did, 
                                 data_total, 
                                 "G90",
                                 filtrado = TRUE)

modelo_compradas_ef <- precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did + 
 fecha + codigo_de_osinergmin

g90_full_con_ef <- reg_clust(modelo_compradas_ef, data_total, "G90")

modelo_compradas_ef_sc <- precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did + tipo_bandera + 
 fecha + codigo_de_osinergmin + sc 

g90_full_ef_sc <- reg_clust(modelo_compradas_ef_sc, data_total, "G90")

# modelo_compradas_controles <- precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did + tipo_bandera + 
#  fecha + grifo_mas_cercano + distancia_min + num_grifos_cerc + 
#   tiene_mecanico + densidad_2017 + ingresos_2012 + num_viajes_millon + sc
# g90_full_full_controls <- reg_clust(modelo_compradas_controles, data_total, "G90")

lista_reg <- list(g90_full_sin_controles, g90_sin3meses_ni_controles,
                  g90_full_con_ef, g90_full_ef_sc)

t <- map(lista_reg, 2)
se <- map(lista_reg, 2) %>% 
  map(~ .[,2])

pe <- map(lista_reg, 2) %>% 
  map(~ .[,4])

stargazer(map(lista_reg, 1),
          type = "html",
          dep.var.labels=str_c("Precio de venta - Gasohol 90 (soles/galón)"),
          dep.var.caption = "",
          model.numbers	= T,
          no.space = F,
          covariate.labels = c("Dum.Vecino", "Dum.FechaCompra", "sc", 
                               "Dum.Vecino*Dum.FechaCompra", "Constante" ),
          column.labels =  "", 
          se = se,
          p = pe,
          omit = c("tipo_bandera", "fecha", "codigo_de_osinergmin"),
          omit.labels = c("Tipo de estación", "Efectos fijos por meses", "Efectos fijos por estación"),
          omit.yes.no = c("Sí", "No"),
          omit.stat	= c("f", "ll", 
                        "sigma2", "res.dev", "ser", "aic",
                        "wald", "lr"),
          notes= "Los errores estándares clusterizados por estación se muestran entre paréntesis. ",
          notes.label = "Notas: ",
          single.row = F, 
          out = here::here("doc", "tables", "g90_did_vecino.htm"))
```

## Hipótesis de tendencias paralelas

```{r hip-diesel}
data_total_test <- fastDummies::dummy_cols(data_total, select_columns = c("fecha")) 

data_total_test <- data_total %>% 
  mutate(timing_test = if_else(fecha < dmy("01-07-2017"), 1, 0))

diesel_full_sin_controles <- reg_clust(precio_de_venta ~ COMPRADA_DID * timing_test, 
                                       data_total_test, 
                                       "DIESEL", 
                                       fecha_lim = c("01-01-2017", "01-10-2017"))


modelo_compradas_ef <- precio_de_venta ~ vecino_pecsa_thiessen_did * `fecha_2017-05-01` +
  COMPRADA_DID * `fecha_2017-06-01` + COMPRADA_DID * `fecha_2017-07-01` +
  COMPRADA_DID * `fecha_2017-08-01` + COMPRADA_DID * `fecha_2017-09-01` +
  COMPRADA_DID * `fecha_2017-10-01` + COMPRADA_DID * `fecha_2017-11-01` + 
  COMPRADA_DID * `fecha_2017-12-01` + COMPRADA_DID * `fecha_2018-01-01` + 
  COMPRADA_DID * `fecha_2018-02-01` + COMPRADA_DID * `fecha_2018-03-01` +
  COMPRADA_DID * `fecha_2018-04-01` + COMPRADA_DID * `fecha_2018-05-01` +
  COMPRADA_DID * `fecha_2018-06-01` + COMPRADA_DID * `fecha_2018-07-01` +
  COMPRADA_DID * `fecha_2018-08-01` + COMPRADA_DID * `fecha_2018-08-01` +
  COMPRADA_DID * `fecha_2018-10-01` + 
  fecha + distrito

diesel_full_con_ef <- reg_clust(modelo_compradas_ef, data_total_test, "DIESEL")

stargazer(diesel_full_con_ef[[2]], type = "text",
          omit = c("codigo"))
```

### Ahora por trimestres para Diésel

```{r}
data_total_tri <- data_total %>%
  mutate(tri_menos_4 = if_else(fecha <= dmy("01-04-2017") & fecha >= dmy("01-02-2017"), 1, 0),
         tri_menos_3 = if_else(fecha <= dmy("01-07-2017") & fecha >= dmy("01-05-2017"), 1, 0),
         tri_menos_2 = if_else(fecha <= dmy("01-10-2017") & fecha >= dmy("01-08-2017"), 1, 0),
         tri_menos_1 = if_else(fecha <= dmy("01-01-2018") & fecha >= dmy("01-11-2017"), 1, 0),
         tri_mas_1 = if_else(fecha <= dmy("01-04-2018") & fecha >= dmy("01-02-2018"), 1, 0),
         tri_mas_2 = if_else(fecha <= dmy("01-07-2018") & fecha >= dmy("01-05-2018"),1,0),
         tri_mas_3 = if_else(fecha <= dmy("01-10-2018") & fecha >= dmy("01-08-2018"),1,0))

controles <-  "tipo_bandera +grifo_mas_cercano + distancia_min + num_grifos_cerc +
  tiene_mecanico + densidad_2017 + ingresos_2012 + num_viajes_millon + sc + distrito"

modelo_test <- precio_de_venta ~ 
   vecino_pecsa_thiessen_did * tri_menos_3 +
  vecino_pecsa_thiessen_did * tri_menos_2 + 
  vecino_pecsa_thiessen_did * tri_menos_1 + vecino_pecsa_thiessen_did * tri_mas_1 + 
  vecino_pecsa_thiessen_did * tri_mas_2 + vecino_pecsa_thiessen_did * tri_mas_3 +
  vecino_pecsa_thiessen_did * tri_menos_4 + tipo_bandera +grifo_mas_cercano + distancia_min + num_grifos_cerc +
  tiene_mecanico + densidad_2017 + ingresos_2012 + num_viajes_millon + sc + distrito

test_trend <- reg_clust(modelo_test, data_total_tri, "DIESEL", c("01-02-2017","01-10-2018" ))
stargazer(test_trend[[2]], type = "text", omit = c("codigo_de"))
```

```{r}

modelo_test <- precio_de_venta ~ 
   COMPRADA_DID * tri_menos_3 +
  COMPRADA_DID * tri_menos_2 + 
  COMPRADA_DID * tri_menos_1 + COMPRADA_DID * tri_mas_1 + 
  COMPRADA_DID * tri_mas_2 + COMPRADA_DID * tri_mas_3 +
  COMPRADA_DID * tri_menos_4 + tipo_bandera +grifo_mas_cercano + distancia_min + num_grifos_cerc +
  tiene_mecanico + densidad_2017 + ingresos_2012 + num_viajes_millon + sc + distrito

test_trend <- reg_clust(modelo_test, data_total_tri, "DIESEL", c("01-02-2017","01-10-2018" ))
stargazer(test_trend[[2]], type = "text", omit = c("codigo_de"))
```

###Para G90

``` {r}
modelo_test <- precio_de_venta ~ 
   vecino_pecsa_thiessen_did * tri_menos_3 +
  vecino_pecsa_thiessen_did * tri_menos_2 + 
  vecino_pecsa_thiessen_did * tri_menos_1 + vecino_pecsa_thiessen_did * tri_mas_1 + 
  vecino_pecsa_thiessen_did * tri_mas_2 + vecino_pecsa_thiessen_did * tri_mas_3 +
  vecino_pecsa_thiessen_did * tri_menos_4 + tipo_bandera + grifo_mas_cercano + distancia_min + num_grifos_cerc +
  tiene_mecanico + densidad_2017 + ingresos_2012 + num_viajes_millon + sc + distrito

test_trend <- reg_clust(modelo_test, data_total_tri, "G90", c("01-02-2017","01-10-2018" ))
stargazer(test_trend[[2]], type = "text", omit = c("codigo_de"))
```

```{r}
modelo_test <- precio_de_venta ~ 
   COMPRADA_DID * tri_menos_3 +
  COMPRADA_DID * tri_menos_2 + 
  COMPRADA_DID * tri_menos_1 + COMPRADA_DID * tri_mas_1 + 
  COMPRADA_DID * tri_mas_2 + COMPRADA_DID * tri_mas_3 +
  COMPRADA_DID * tri_menos_4  + tipo_bandera +grifo_mas_cercano + distancia_min +
  num_grifos_cerc + tiene_mecanico + densidad_2017 + ingresos_2012 + num_viajes_millon + sc + distrito

test_trend <- reg_clust(modelo_test, data_total_tri, "G90", c("01-02-2017","01-10-2018" ))
stargazer(test_trend[[2]], type = "text", omit = c("codigo_de"))
```

###Para G90 menos tiempo

``` {r}
modelo_test <- precio_de_venta ~ 
  vecino_pecsa_thiessen_did * tri_menos_2 + 
  vecino_pecsa_thiessen_did * tri_menos_1 + vecino_pecsa_thiessen_did * tri_mas_1 + 
  vecino_pecsa_thiessen_did * tri_mas_2 + vecino_pecsa_thiessen_did * tri_mas_3 +
+ tipo_bandera + grifo_mas_cercano + distancia_min + num_grifos_cerc +
  tiene_mecanico + densidad_2017 + ingresos_2012 + num_viajes_millon + sc + distrito +
   vecino_pecsa_thiessen_did * tri_menos_3

test_trend <- reg_clust(modelo_test, data_total_tri, "G90", c("01-05-2017","01-10-2018" ))
stargazer(test_trend[[2]], type = "text", omit = c("codigo_de"))
```

```{r}
modelo_test <- precio_de_venta ~ 
  COMPRADA_DID * tri_menos_2 + 
  COMPRADA_DID * tri_menos_1 + COMPRADA_DID * tri_mas_1 + 
  COMPRADA_DID * tri_mas_2 + COMPRADA_DID * tri_mas_3 +
  tipo_bandera +grifo_mas_cercano + distancia_min +
  num_grifos_cerc + tiene_mecanico + densidad_2017 + ingresos_2012 + num_viajes_millon + sc + distrito +COMPRADA_DID * tri_menos_3 


test_trend <- reg_clust(modelo_test, data_total_tri, "G90", c("01-05-2017","01-10-2018" ))
stargazer(test_trend[[2]], type = "text", omit = c("codigo_de"))
```