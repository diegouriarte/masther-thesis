---
title: "Análisis de diferencias en diferencias"
author: "Diego Uriarte"
date: "`r format(Sys.Date())`"
output:
  html_notebook:
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    error = TRUE,
    message = FALSE,
    warning = FALSE
)
options(tidyverse.quiet = TRUE)

```

```{r  body, warning = FALSE, message = FALSE}
library(conflicted)
library(tidyverse)
library(lubridate)
library(stargazer)
library(multiwayvcov)
library(lmtest)
source(here::here("R","funcion04_formato-tablas-reproducibles.R"), encoding = "UTF-8")
'%ni%' <- Negate('%in%')
conflict_prefer("filter", "dplyr")
```

## Cargamos datos


```{r cargar-datos}

data_total <- readRDS(file = here::here("data", "processed", "data-final-regresiones.rds"))

data_total <- data_total %>% 
  mutate(codigo_de_osinergmin = factor(codigo_de_osinergmin)) %>% 
  mutate(tri_menos_4 = if_else(fecha <= dmy("01-04-2017") & fecha >= dmy("01-02-2017"), 1, 0),
         tri_menos_3 = if_else(fecha <= dmy("01-07-2017") & fecha >= dmy("01-05-2017"), 1, 0),
         tri_menos_2 = if_else(fecha <= dmy("01-10-2017") & fecha >= dmy("01-08-2017"), 1, 0),
         tri_menos_1 = if_else(fecha <= dmy("01-01-2018") & fecha >= dmy("01-11-2017"), 1, 0),
         tri_mas_1 = if_else(fecha <= dmy("01-04-2018") & fecha >= dmy("01-02-2018"), 1, 0),
         tri_mas_2 = if_else(fecha <= dmy("01-07-2018") & fecha >= dmy("01-05-2018"),1,0),
         tri_mas_3 = if_else(fecha <= dmy("01-10-2018") & fecha >= dmy("01-08-2018"),1,0))
```

## Creamos variables
Con la data tipo panel debes tener una dummy que identifique cada observación (grifo-mes) acorde con si pertenece al grupo de tratamiento/control y otra para identificar si su período corresponde a antes/después de la fusión

a) variable tratamiento/control: la idea es ver el impacto de la fusión. Entonces el tratamiento debería ser algo relacionado a ser afectado por la fusión. Hay varias alternativas. Podría ser "ser un grifo del grupo fusionado Primax" o "ser un grifo colindante con un grifo que pertenece a la fusión". Diría que la 2da es más relevante, pero la 1era también es interesante. La dummy sería igual a 1 para todo grifo que pase eventualmente por el tratamiento, sea como sea que lo definas, e igual a cero para los grifos que pasen a formar parte de tu grupo de control.

b) variable timing: lo más sencillo sería una dummy = 0 para todo mes antes de la fusión, =1 para todo mes posterior. Se puede elaborar más y tener una dummy por trimestre o mes. 


Ahora especificamos modelos:

```{r func-reg}
reg_clust <- function(form, 
                      data, 
                      producto, 
                      fecha_lim = c("01-05-2017", "01-10-2018"), 
                      filtrado = FALSE){
  if (filtrado == TRUE) {
    data_filtrada <- balancear_panel(data, prod = producto) %>% 
      filter(fecha >= dmy("01-04-2018") | fecha <= dmy("01-11-2017")) %>% 
      mutate(fecha = factor(fecha)) 
  } else {
    data_filtrada <- balancear_panel(data, prod = producto, fecha_lim) %>% 
      mutate(fecha = factor(fecha))
  }

  modelo <- lm(formula = form, 
                           data = data_filtrada)  
  m1.vcovCL <- cluster.vcov(modelo,data_filtrada$codigo_de_osinergmin)
list(modelo, coeftest(modelo, m1.vcovCL))
}
```

### DiD efecto compra

```{r modelos-compra}

modelo_sin_controles <- precio_de_venta ~ COMPRADA_DID * timing_did

modelo_compradas_ef <- precio_de_venta ~ COMPRADA_DID * timing_did + 
 fecha + distrito

modelo_compradas_controles <- precio_de_venta ~ COMPRADA_DID * timing_did + 
  fecha + 
  tipo_bandera + grifo_mas_cercano + distancia_min + num_grifos_cerc +
  tiene_mecanico + densidad_2017 + ingresos_2012 + 
  num_viajes_millon + sc + distrito 

modelo_tri <- precio_de_venta ~ 
  COMPRADA_DID * timing_did +
  COMPRADA_DID * tri_menos_1 + 
  # COMPRADA_DID * tri_menos_3 + 
  COMPRADA_DID * tri_mas_1 + 
  COMPRADA_DID * tri_mas_2 + 
  COMPRADA_DID * tri_mas_3 +
  tipo_bandera + grifo_mas_cercano + distancia_min + num_grifos_cerc +
  tiene_mecanico + densidad_2017 + ingresos_2012 + 
  num_viajes_millon + sc + distrito +
  fecha + 
  COMPRADA_DID * tri_menos_2 
```


### Diesel efecto compra 


```{r reg-diesel-compra}
diesel_full_sin_controles <- reg_clust(modelo_sin_controles, data_total,
                                       "DIESEL",
                                       fecha_lim = c("01-08-2017","01-10-2018" ))

diesel_full_con_ef <- reg_clust(modelo_compradas_ef, data_total, 
                                "DIESEL",
                                fecha_lim = c("01-08-2017","01-10-2018" ))

diesel_full_controls <- reg_clust(modelo_compradas_controles, data_total, 
                                  "DIESEL",
                                  fecha_lim = c("01-08-2017","01-10-2018" ))

reg_diesel_tri_compra <- reg_clust(modelo_tri, data_total, "DIESEL", c("01-08-2017","01-10-2018" ))

```


```{r ouput-stargarzer-diesel-compra}
lista_reg <- list(diesel_full_sin_controles, 
                  # diesel_sin3meses_ni_controles,
                  diesel_full_con_ef, 
                  # diesel_full_ef_sc, 
                  diesel_full_controls,
                  reg_diesel_tri_compra)

t <- map(lista_reg, 2)
se <- map(lista_reg, 2) %>% 
  map(~ .[,2])

pe <- map(lista_reg, 2) %>% 
  map(~ .[,4])

stargazer(map(lista_reg, 1),
          type = "html",
          dep.var.labels=str_c("Precio de venta - Diésel (soles/galón)"),
          dep.var.caption = "",
          model.numbers	= T,
          no.space = F,
          # covariate.labels = c("Dum.Comprada", "Dum.FechaCompra", "sc", 
                               # "Dum.Comprada*Dum.FechaCompra", "Constante" ),
          column.labels =  "", 
          se = se,
          p = pe,
          omit = c("tipo_bandera", "fecha", 
                   "codigo_de_osinergmin", "distrito", "^tri_m"),
          # omit.labels = c("Tipo de estación", "Efectos fijos por meses", "Efectos fijos por estación", "EF Distritos"),
          omit.yes.no = c("Sí", "No"),
          omit.stat	= c("f", "ll", 
                        "sigma2", "res.dev", "ser", "aic",
                        "wald", "lr"),
          notes= "Los errores estándares clusterizados por estación se muestran entre paréntesis. ",
          notes.label = "Notas: ",
          single.row = F, 
          out = here::here("doc", "tables", "diesel_did_compra.htm"))
```


### Gasohol 90 compra

```{r reg-gasohol-compra}
g90_full_sin_controles <- reg_clust(modelo_sin_controles, data_total,
                                    "G90",
                                    fecha_lim = c("01-08-2017","01-10-2018" ))

g90_full_con_ef <- reg_clust(modelo_compradas_ef, data_total, 
                             "G90",
                             fecha_lim = c("01-08-2017","01-10-2018" ))

g90_full_controls <- reg_clust(modelo_compradas_controles, data_total, 
                               "G90",
                               fecha_lim = c("01-08-2017","01-10-2018" ))

g90_trimestre_compra <- reg_clust(modelo_tri, data_total, "G90", c("01-08-2017","01-10-2018" ))

```


```{r output-stargarzer-gasohol-comra}
lista_reg <- list(g90_full_sin_controles, g90_full_con_ef,
                  g90_full_controls, g90_trimestre_compra)

t <- map(lista_reg, 2)
se <- map(lista_reg, 2) %>% 
  map(~ .[,2])

pe <- map(lista_reg, 2) %>% 
  map(~ .[,4])

stargazer(map(lista_reg, 1),
          type = "html",
          # dep.var.labels=str_c("Precio de venta - Gasohol 90 (soles/galón)"),
          # dep.var.caption = "",
          model.numbers	= T,
          no.space = T,
          # covariate.labels = c("Dum.Comprada", "Dum.FechaCompra", "sc", 
                               # "Dum.Comprada*Dum.FechaCompra", "Constante" ),
          # column.labels =  "", 
          se = se,
          p = pe,
          omit = c("tipo_bandera", "fecha", 
                   "codigo_de_osinergmin", "distrito", "^tri_m"),
          omit.stat	= c("f", "ll", 
                        "sigma2", "res.dev", "ser", "aic",
                        "wald", "lr"),
          notes= "Los errores estándares clusterizados por estación se muestran entre paréntesis. ",
          notes.label = "Notas: ",
          single.row = F, 
          out = here::here("doc", "tables", "g90_did_compra.htm"))
```




## DiD efecto vecinos

```{r modelos-vecino}

modelo_sin_controles <- precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did

modelo_compradas_ef <- precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did + 
 fecha + distrito

modelo_compradas_controles <- precio_de_venta ~ vecino_pecsa_thiessen_did * timing_did + 
  fecha + 
  tipo_bandera + grifo_mas_cercano + distancia_min + num_grifos_cerc +
  tiene_mecanico + densidad_2017 + ingresos_2012 + 
  num_viajes_millon + sc + distrito 

modelo_tri <- precio_de_venta ~ 
  vecino_pecsa_thiessen_did * tri_menos_1 + 
  # vecino_pecsa_thiessen_did * tri_menos_3 + 
  vecino_pecsa_thiessen_did * tri_mas_1 + 
  vecino_pecsa_thiessen_did * tri_mas_2 + 
  vecino_pecsa_thiessen_did * tri_mas_3 +
  tipo_bandera + grifo_mas_cercano + distancia_min + num_grifos_cerc +
  tiene_mecanico + densidad_2017 + ingresos_2012 + 
  num_viajes_millon + sc + distrito +
  fecha + 
  vecino_pecsa_thiessen_did * tri_menos_2 
```

### Diesel efecto vecinos 


```{r reg-diesel-vecino}
diesel_full_sin_controles <- reg_clust(modelo_sin_controles, data_total,
                                       "DIESEL",
                                       fecha_lim = c("01-08-2017","01-10-2018" ))

diesel_full_con_ef <- reg_clust(modelo_compradas_ef, data_total, 
                                "DIESEL",
                                fecha_lim = c("01-08-2017","01-10-2018" ))

diesel_full_controls <- reg_clust(modelo_compradas_controles, data_total, 
                                  "DIESEL",
                                  fecha_lim = c("01-08-2017","01-10-2018" ))

reg_diesel_tri_compra <- reg_clust(modelo_tri, data_total, "DIESEL", c("01-08-2017","01-10-2018" ))

```


```{r ouput-stargarzer-diesel-vecinos}
lista_reg <- list(diesel_full_sin_controles, 
                  # diesel_sin3meses_ni_controles,
                  diesel_full_con_ef, 
                  # diesel_full_ef_sc, 
                  diesel_full_controls,
                  reg_diesel_tri_compra)

t <- map(lista_reg, 2)
se <- map(lista_reg, 2) %>% 
  map(~ .[,2])

pe <- map(lista_reg, 2) %>% 
  map(~ .[,4])

stargazer(map(lista_reg, 1),
          type = "html",
          model.numbers	= T,
          no.space = T,
          # covariate.labels = c("Dum.Comprada", "Dum.FechaCompra", "sc", 
                               # "Dum.Comprada*Dum.FechaCompra", "Constante" ),
          column.labels =  "", 
          se = se,
          p = pe,
          omit = c("tipo_bandera", "fecha", 
                   "codigo_de_osinergmin", "distrito", "^tri_m"),
          # omit.labels = c("Tipo de estación", "Efectos fijos por meses", "Efectos fijos por estación", "EF Distritos"),
          omit.yes.no = c("Sí", "No"),
          omit.stat	= c("f", "ll", 
                        "sigma2", "res.dev", "ser", "aic",
                        "wald", "lr"),
          notes= "Los errores estándares clusterizados por estación se muestran entre paréntesis. ",
          notes.label = "Notas: ",
          single.row = F, 
          out = here::here("doc", "tables", "diesel_did_vecino.htm"))
```

### Gasohol 90 vecinos

```{r reg-gasohol-vecino}
g90_full_sin_controles <- reg_clust(modelo_sin_controles, data_total,
                                    "G90",
                                    fecha_lim = c("01-08-2017","01-10-2018" ))

g90_full_con_ef <- reg_clust(modelo_compradas_ef, data_total, 
                             "G90",
                             fecha_lim = c("01-08-2017","01-10-2018" ))

g90_full_controls <- reg_clust(modelo_compradas_controles, data_total, 
                               "G90",
                               fecha_lim = c("01-08-2017","01-10-2018" ))

g90_trimestre_compra <- reg_clust(modelo_tri, data_total, "G90", c("01-08-2017","01-10-2018" ))

```


```{r output-stargarzer-gasohol-vecino}
lista_reg <- list(g90_full_sin_controles, g90_full_con_ef,
                  g90_full_controls, g90_trimestre_compra)

t <- map(lista_reg, 2)
se <- map(lista_reg, 2) %>% 
  map(~ .[,2])

pe <- map(lista_reg, 2) %>% 
  map(~ .[,4])

stargazer(map(lista_reg, 1),
          type = "html",
          # dep.var.labels=str_c("Precio de venta - Gasohol 90 (soles/galón)"),
          # dep.var.caption = "",
          model.numbers	= T,
          no.space = T,
          # covariate.labels = c("Dum.Comprada", "Dum.FechaCompra", "sc", 
                               # "Dum.Comprada*Dum.FechaCompra", "Constante" ),
          # column.labels =  "", 
          se = se,
          p = pe,
          omit = c("tipo_bandera", "fecha", 
                   "codigo_de_osinergmin", "distrito", "^tri_m"),
          omit.stat	= c("f", "ll", 
                        "sigma2", "res.dev", "ser", "aic",
                        "wald", "lr"),
          order = c("^vecino_pecsa_thiessen_did", "^timing_did",
                    "^vecino_pecsa_thiessen_did:timing_did"),
          notes= "Los errores estándares clusterizados por estación se muestran entre paréntesis. ",
          notes.label = "Notas: ",
          single.row = F, 
          out = here::here("doc", "tables", "g90_did_vecino.htm"))
```




