Data wrangling
================
Diego Uriarte
5/02/2019

Now, we assign correct format to data and correct obvious mistakes

Packages to
    use

``` r
library(here)
```

    ## here() starts at E:/Dropbox/projects/masther-thesis

``` r
library(tidyverse)
```

    ## -- Attaching packages -------------------------------------------------------------------------------------------------------------- tidyverse 1.2.1 --

    ## v ggplot2 3.1.0     v purrr   0.3.0
    ## v tibble  2.0.1     v dplyr   0.7.8
    ## v tidyr   0.8.2     v stringr 1.3.1
    ## v readr   1.3.1     v forcats 0.3.0

    ## -- Conflicts ----------------------------------------------------------------------------------------------------------------- tidyverse_conflicts() --
    ## x dplyr::filter() masks stats::filter()
    ## x dplyr::lag()    masks stats::lag()

``` r
library(readxl)
library(janitor)
library(skimr)
library(lubridate)
```

    ## 
    ## Attaching package: 'lubridate'

    ## The following object is masked from 'package:here':
    ## 
    ##     here

    ## The following object is masked from 'package:base':
    ## 
    ##     date

``` r
library(purrr)
```

We load the previouly generated files that contain all information from
2005 to
2008

``` r
data_2005_2017 <- readRDS(file = here::here("data","processed","data_2005_2017.rds"))
data_2017_2018 <- readRDS(file = here::here("data","processed","data_2017_2018.rds"))
```

clean names using janitor package

``` r
data_2005_2017 <- data_2005_2017 %>% clean_names()
skim(data_2005_2017)
```

    ## Skim summary statistics
    ##  n obs: 273170 
    ##  n variables: 16 
    ## 
    ## -- Variable type:character ----------------------------------------------------------------------------------------------------------------------------
    ##               variable missing complete      n min max empty n_unique
    ##                    ano       2   273168 273170   4   4     0       13
    ##         codigo_osinerg       2   273168 273170   4   6     0     1773
    ##  descripcion_actividad       1   273169 273170  12  64     0        7
    ##   descripcion_producto       2   273168 273170   7  23     0       27
    ##                    dia       2   273168 273170   2   2     0       31
    ##              direccion       2   273168 273170  12 150     0     1761
    ##                empresa       2   273168 273170   7  82     0     1560
    ##         fecha_registro       2   273168 273170  10  10     0     4010
    ##          hora_registro       2   273168 273170  11  11     0    47031
    ##                    mes       2   273168 273170   2   2     0       12
    ##                nomdepa       2   273168 273170   3  13     0       24
    ##                nomdist       2   273168 273170   3  36     0      532
    ##                nomprov       2   273168 273170   3  23     0      160
    ##                    ruc       4   273166 273170   1  11     0     1506
    ## 
    ## -- Variable type:logical ------------------------------------------------------------------------------------------------------------------------------
    ##  variable missing complete      n mean  count
    ##  unidades  273170        0 273170  NaN 273170
    ## 
    ## -- Variable type:numeric ------------------------------------------------------------------------------------------------------------------------------
    ##      variable missing complete      n  mean      sd   p0   p25   p50   p75
    ##  precio_venta       2   273168 273170 23.76 3296.13 0.01 10.79 12.32 13.99
    ##    p100     hist
    ##  994502 <U+2587><U+2581><U+2581><U+2581><U+2581><U+2581><U+2581><U+2581>

We found to missing values por aæ˜¼ã¸±o, let’s see which they are:

``` r
data_2005_2017 %>% filter(is.na(ano))
```

    ## # A tibble: 2 x 16
    ##   descripcion_act~ codigo_osinerg empresa ruc   nomdepa nomprov nomdist
    ##   <chr>            <chr>          <chr>   <chr> <chr>   <chr>   <chr>  
    ## 1 <NA>             <NA>           <NA>    <NA>  <NA>    <NA>    <NA>   
    ## 2 Fuente: SCOP     <NA>           <NA>    <NA>  <NA>    <NA>    <NA>   
    ## # ... with 9 more variables: direccion <chr>, ano <chr>, mes <chr>,
    ## #   dia <chr>, fecha_registro <chr>, hora_registro <chr>,
    ## #   descripcion_producto <chr>, precio_venta <dbl>, unidades <lgl>

We can drop those observation:

``` r
data_2005_2017 <- data_2005_2017 %>% drop_na(ano)

skim(data_2005_2017)
```

    ## Skim summary statistics
    ##  n obs: 273168 
    ##  n variables: 16 
    ## 
    ## -- Variable type:character ----------------------------------------------------------------------------------------------------------------------------
    ##               variable missing complete      n min max empty n_unique
    ##                    ano       0   273168 273168   4   4     0       13
    ##         codigo_osinerg       0   273168 273168   4   6     0     1773
    ##  descripcion_actividad       0   273168 273168  16  64     0        6
    ##   descripcion_producto       0   273168 273168   7  23     0       27
    ##                    dia       0   273168 273168   2   2     0       31
    ##              direccion       0   273168 273168  12 150     0     1761
    ##                empresa       0   273168 273168   7  82     0     1560
    ##         fecha_registro       0   273168 273168  10  10     0     4010
    ##          hora_registro       0   273168 273168  11  11     0    47031
    ##                    mes       0   273168 273168   2   2     0       12
    ##                nomdepa       0   273168 273168   3  13     0       24
    ##                nomdist       0   273168 273168   3  36     0      532
    ##                nomprov       0   273168 273168   3  23     0      160
    ##                    ruc       2   273166 273168   1  11     0     1506
    ## 
    ## -- Variable type:logical ------------------------------------------------------------------------------------------------------------------------------
    ##  variable missing complete      n mean  count
    ##  unidades  273168        0 273168  NaN 273168
    ## 
    ## -- Variable type:numeric ------------------------------------------------------------------------------------------------------------------------------
    ##      variable missing complete      n  mean      sd   p0   p25   p50   p75
    ##  precio_venta       0   273168 273168 23.76 3296.13 0.01 10.79 12.32 13.99
    ##    p100     hist
    ##  994502 <U+2587><U+2581><U+2581><U+2581><U+2581><U+2581><U+2581><U+2581>

Now, ruc still has two missing values:

``` r
data_2005_2017 %>% filter(is.na(ruc)) 
```

    ## # A tibble: 2 x 16
    ##   descripcion_act~ codigo_osinerg empresa ruc   nomdepa nomprov nomdist
    ##   <chr>            <chr>          <chr>   <chr> <chr>   <chr>   <chr>  
    ## 1 GRIFOS RURALES ~ 18495          LUIS E~ <NA>  PIURA   MORROP~ BUENOS~
    ## 2 GRIFOS RURALES ~ 18495          LUIS E~ <NA>  PIURA   MORROP~ BUENOS~
    ## # ... with 9 more variables: direccion <chr>, ano <chr>, mes <chr>,
    ## #   dia <chr>, fecha_registro <chr>, hora_registro <chr>,
    ## #   descripcion_producto <chr>, precio_venta <dbl>, unidades <lgl>

We see that is a fuel station without ruc than only appears twice in the
dataset. We will drop these fuel station:

``` r
data_2005_2017 <- data_2005_2017 %>% drop_na(ruc)

skim(data_2005_2017)
```

    ## Skim summary statistics
    ##  n obs: 273166 
    ##  n variables: 16 
    ## 
    ## -- Variable type:character ----------------------------------------------------------------------------------------------------------------------------
    ##               variable missing complete      n min max empty n_unique
    ##                    ano       0   273166 273166   4   4     0       13
    ##         codigo_osinerg       0   273166 273166   4   6     0     1772
    ##  descripcion_actividad       0   273166 273166  16  64     0        6
    ##   descripcion_producto       0   273166 273166   7  23     0       27
    ##                    dia       0   273166 273166   2   2     0       31
    ##              direccion       0   273166 273166  12 150     0     1760
    ##                empresa       0   273166 273166   7  82     0     1559
    ##         fecha_registro       0   273166 273166  10  10     0     4010
    ##          hora_registro       0   273166 273166  11  11     0    47031
    ##                    mes       0   273166 273166   2   2     0       12
    ##                nomdepa       0   273166 273166   3  13     0       24
    ##                nomdist       0   273166 273166   3  36     0      532
    ##                nomprov       0   273166 273166   3  23     0      160
    ##                    ruc       0   273166 273166   1  11     0     1506
    ## 
    ## -- Variable type:logical ------------------------------------------------------------------------------------------------------------------------------
    ##  variable missing complete      n mean  count
    ##  unidades  273166        0 273166  NaN 273166
    ## 
    ## -- Variable type:numeric ------------------------------------------------------------------------------------------------------------------------------
    ##      variable missing complete      n  mean      sd   p0   p25   p50   p75
    ##  precio_venta       0   273166 273166 23.76 3296.14 0.01 10.79 12.32 13.99
    ##    p100     hist
    ##  994502 <U+2587><U+2581><U+2581><U+2581><U+2581><U+2581><U+2581><U+2581>

Now, unidades is completely missing, so I drop it:

``` r
data_2005_2017 <- data_2005_2017 %>% 
    select(-unidades, departamento = 'nomdepa',
           provincia = 'nomprov', distrito = 'nomdist',
           -ano, -mes, -dia)

data_2005_2017 <- data_2005_2017 %>%
    unite(fecha_hora, fecha_registro, hora_registro, sep = " ") %>%
    mutate(fecha_hora = dmy_hms(fecha_hora))

data_2005_2017 %>% 
    filter(precio_venta < 10000, precio_venta > 1000) %>%
    view()

correct_price <- function(price) {
    if (price < 25) {
        return (price)
    } else {
        return(correct_price(price/10))
    }
}

data_2005_2017 %>% 
    mutate(precio_rev = map_dbl(data_2005_2017$precio_venta, 
                                correct_price),
           diff = precio_rev == precio_venta) %>%
    select(-2:-8) %>%
    filter(diff == FALSE ) %>%
    arrange(precio_venta) %>% View()

data_2005_2017 %>% 
    mutate(precio_rev = map_dbl(data_2005_2017$precio_venta, 
                                correct_price),
           diff = precio_rev == precio_venta) %>%
    skim(precio_rev)
```

    ## Skim summary statistics
    ##  n obs: 273166 
    ##  n variables: 13 
    ## 
    ## -- Variable type:numeric ------------------------------------------------------------------------------------------------------------------------------
    ##    variable missing complete      n  mean   sd   p0   p25   p50   p75
    ##  precio_rev       0   273166 273166 12.41 2.62 0.01 10.79 12.32 13.99
    ##   p100     hist
    ##  22.42 <U+2581><U+2581><U+2581><U+2585><U+2587><U+2583><U+2581><U+2581>

Everything looks normal now with the histogram, so we save this into the
object

``` r
data_2005_2017 <- data_2005_2017 %>% 
    mutate(precio_venta = map_dbl(data_2005_2017$precio_venta, 
                                correct_price))

skim(data_2005_2017)
```

    ## Skim summary statistics
    ##  n obs: 273166 
    ##  n variables: 11 
    ## 
    ## -- Variable type:character ----------------------------------------------------------------------------------------------------------------------------
    ##               variable missing complete      n min max empty n_unique
    ##         codigo_osinerg       0   273166 273166   4   6     0     1772
    ##           departamento       0   273166 273166   3  13     0       24
    ##  descripcion_actividad       0   273166 273166  16  64     0        6
    ##   descripcion_producto       0   273166 273166   7  23     0       27
    ##              direccion       0   273166 273166  12 150     0     1760
    ##               distrito       0   273166 273166   3  36     0      532
    ##                empresa       0   273166 273166   7  82     0     1559
    ##              provincia       0   273166 273166   3  23     0      160
    ##                    ruc       0   273166 273166   1  11     0     1506
    ## 
    ## -- Variable type:numeric ------------------------------------------------------------------------------------------------------------------------------
    ##      variable missing complete      n  mean   sd   p0   p25   p50   p75
    ##  precio_venta       0   273166 273166 12.41 2.62 0.01 10.79 12.32 13.99
    ##   p100     hist
    ##  22.42 <U+2581><U+2581><U+2581><U+2585><U+2587><U+2583><U+2581><U+2581>
    ## 
    ## -- Variable type:POSIXct ------------------------------------------------------------------------------------------------------------------------------
    ##    variable missing complete      n        min        max     median
    ##  fecha_hora       0   273166 273166 2005-01-01 2017-06-20 2013-10-24
    ##  n_unique
    ##    107560
