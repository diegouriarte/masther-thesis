---
title: "Spatial clustering luego de venta"
output:
  html_notebook: default
---

# Cargamos librerías

```{r}
suppressMessages(library(tidyverse))
library(knitr)
library(kableExtra)
library(forcats)

```

# A nivel bandera

## Cargamos archivos

```{r}
grifos_sc_pre <- readRDS(here::here("data","processed","grifos_con_sc_pre_venta.RDS"))
grifos_sc_post <- readRDS(here::here("data","processed","grifos_con_sc_post_venta.RDS"))
```

Hacemos merge de ambas
```{r}
grifos_sc <- grifos_sc_post %>%
    rename(sc_post = sc)
grifos_sc$sc_pre <- grifos_sc_pre$sc

grifos_sc %>% 
    mutate(diff_sc = sc_post - sc_pre) %>%
    group_by(bandera) %>%
    summarise(mean_diff_sc = mean(diff_sc),
              n = n())
```
```{r}
grifos_sc %>%
    filter(stringr::str_detect(razon_social, "PERUANA DE ESTACIONES"))
```

# A nivel razon social

## Cargamos archivos

```{r}
grifos_sc_pre <- readRDS(here::here("data","processed","grifos_con_sc_pre_venta_razon.RDS"))
grifos_sc_post <- readRDS(here::here("data","processed","grifos_con_sc_post_venta_razon.RDS"))

grifos_sc_pre %>%
    count(razon_social, sort = TRUE)
```

Hacemos merge de ambas
```{r}
# grifos_sc <- grifos_sc_post %>%
#     rename(sc_post = sc)
# grifos_sc$sc_pre <- grifos_sc_pre$sc

grifos_sc <- grifos_sc_pre %>%
    rename(sc_pre = sc)
grifos_sc$sc_post <- grifos_sc_post$sc

grifos_sc_1 <- grifos_sc %>% 
    mutate(diff_sc = sc_post - sc_pre,
           razon_social_sum = if_else(razon_social %in% c("REPSOL COMERCIAL S.A.C.", 
                                                          "COESTI S.A.", 
                                                          "PERUANA DE ESTACIONES DE SERVICIOS S.A.C."),
                                      razon_social,
                                      "OTRA RAZÓN"))

grifos_sc_1 %>% 
    group_by(razon_social_sum) %>%
    summarise(mean_diff_sc = mean(diff_sc),
              sd = sd(diff_sc),
              n = n())
```


```{r}
df1 <- grifos_sc_1 %>% 
    filter(diff_sc != 0)  %>%
    group_by(razon_social_sum) %>%
    summarise(Promedio= mean(diff_sc),
              SD = sd(diff_sc),
              "Mínimo" = min(diff_sc),
              "Máximo" = max(diff_sc),
              "Numero de Obs." = n()) %>%
    mutate(razon_social_sum= fct_relevel(razon_social_sum, 
                                         "PERUANA DE ESTACIONES DE SERVICIOS S.A.C.",
                                         "COESTI S.A.", 
                                         "REPSOL COMERCIAL S.A.C.",
                                         "OTRA RAZÓN",
                                         "Todas las estaciones")) %>%
    arrange(razon_social_sum) %>%
    select(1, 6, 2, 3, 4, 5)


df2 <- grifos_sc_1 %>% 
    filter(diff_sc != 0)  %>%
    mutate(razon_social_sum = "TODAS LAS ESTACIONES") %>%
    group_by(razon_social_sum) %>%
    summarise(Promedio= mean(diff_sc),
              SD = sd(diff_sc),
              "Mínimo" = min(diff_sc),
              "Máximo" = max(diff_sc),
              "Numero de Obs." = n()) %>%
    select(1, 6, 2, 3, 4, 5)

x <- bind_rows(df1, df2) %>%
    rename("Razón Social" = razon_social_sum) %>%
    kable(format = "html", 
          digits = c(0, 0, 3, 3, 3, 3)) %>%
    kable_styling(full_width = FALSE, position = "left") 
x
pack_rows(x, "Grupo de tratamiento", 1,5)
```
```{r}
df3 <- grifos_sc_1 %>% 
    filter(diff_sc == 0)  %>%
    group_by(razon_social_sum) %>%
    summarise("Numero de Obs." = n()) %>%
    mutate(razon_social_sum= fct_relevel(razon_social_sum, 
                                         "PERUANA DE ESTACIONES DE SERVICIOS S.A.C.",
                                         "COESTI S.A.", 
                                         "REPSOL COMERCIAL S.A.C.",
                                         "OTRA RAZÓN",
                                         "Todas las estaciones"),
           Promedio = 0) %>%
    arrange(razon_social_sum) 


df4 <- grifos_sc_1 %>% 
    filter(diff_sc == 0)  %>%
    mutate(razon_social_sum = "TODAS LAS ESTACIONES") %>%
    group_by(razon_social_sum) %>%
    summarise("Numero de Obs." = n()) %>%
    mutate(Promedio = 0) %>%
    arrange(razon_social_sum) 

options(knitr.kable.NA = '-')

bind_rows(df1, df2, df3, df4) %>%
    rename("Razón Social" = razon_social_sum) %>%
    kable(format = "html", 
          digits = c(0, 0, 3, 3, 3, 3)) %>%
    kable_styling(full_width = FALSE, position = "left") %>%
    pack_rows("Grupo de Tratamiento", 1, 5) %>%
    pack_rows("Grupo de Control", 6, 10)

```


