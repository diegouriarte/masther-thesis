---
title: "Creación de database con spatial_clustering a nivel de banderas"
output: html_notebook
---

#Cargamos librerias necesarias y funciones

```{r}
suppressMessages(library(tidyverse))
source(here::here("R","2.6_calculo-spatial-clustering_funciones.R"))
library(purrr)

```

#Cargamos dataset con grifos y vecinos de Thiessen
Cargamos dos archivos generados previamente:
 - File con los vecinos de Thiessen generado en `r "2.5_estaciones-thiessen.Rmd"`. 
 - File con la lista de grifos y sus características generado en `r "1.6_base-datos-grifos-para-regresion.R"`

```{r}
grifos <- readRDS(here::here("data","processed","grifo_con_vecinos.RDS"))
grifos_coding_clean <- readRDS(here::here("data","processed","grifo_coding_clean.rds"))

```


#Calculo de SC para la muestra



```{r}
grifos_sc <- grifos %>%
    distinct(codigo_de_osinergmin.princ) %>%
    mutate(sc = NA)
```

```{r}
ptm <- proc.time()
sc_vector <- map_dbl(grifos_sc$codigo_de_osinergmin.princ, calcular_sc)
proc.time() - ptm

grifos_sc$sc <- sc_vector


```


Hacemos merge con el dataset anterior:

```{r}
grifos_sc_pre <- left_join(grifos_coding_clean, 
                           grifos_sc, 
                           c("codigo_de_osinergmin" = "codigo_de_osinergmin.princ")) 


```

# Calculo post-venta

Ahora, cambiamos las banderas que dicen Pecsa por Primax, 


```{r}
#cargamos la nueva base de datos con el nombre de grifos, de lo contrario no funcionan las funciones
grifos <- readRDS(here::here("data","processed","grifo_con_vecinos_post.RDS")) 
grifos_coding_clean_post <- grifos_coding_clean %>%
    mutate(bandera = recode_factor(bandera, "PECSA" = "PRIMAX"))
```


```{r}
grifos_sc_post <- grifos_post %>%
    distinct(codigo_de_osinergmin.princ) %>%
    mutate(sc = NA)
```

```{r}
ptm <- proc.time()
sc_vector_post <- map_dbl(grifos_sc_post$codigo_de_osinergmin.princ, calcular_sc)
proc.time() - ptm

grifos_sc_post$sc <- sc_vector_post

grifos_sc_post_1 <- left_join(grifos_coding_clean_post, 
                           grifos_sc_post, 
                           c("codigo_de_osinergmin" = "codigo_de_osinergmin.princ")) 

```

Grabamos el dataset para ser usado luego:

```{r}
saveRDS(grifos_sc_pre, file = here::here("data","processed","grifos_con_sc_pre_venta.RDS"))
saveRDS(grifos_sc_post_1, file = here::here("data","processed","grifos_con_sc_post_venta.RDS"))

```

