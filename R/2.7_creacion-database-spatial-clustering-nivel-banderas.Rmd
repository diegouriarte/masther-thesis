---
title: "Creación de database con spatial_clustering a nivel de banderas"
output: html_notebook
---

#Cargamos librerias necesarias y funciones

```{r}
suppressMessages(library(tidyverse))
source(here::here("R","2.6_calculo-spatial-clustering_funciones.R"))
```

#Cargamos dataset con grifos y vecinos de Thiessen
Cargamos dos archivos generados previamente:
 - File con los vecinos de Thiessen generado en `r "2.5_estaciones-thiessen.Rmd"`. 
 - File con la lista de grifos y sus características generado en `r "1.6_base-datos-grifos-para-regresion.R"`

```{r}
grifos <- readRDS(here::here("data","processed","grifo_con_vecinos.RDS"))
grifos_coding_clean <- readRDS(here::here("data","processed","grifo_coding_clean.rds"))

glimpse(grifos)
glimpse(grifos_coding_clean)
```


#Calculo de SC para la muestra



```{r}
grifos_sc <- grifos %>%
    distinct(codigo_de_osinergmin.princ) %>%
    mutate(sc = NA)
```

```{r}
library(purrr)
ptm <- proc.time()
sc_vector <- map_dbl(grifos_sc$codigo_de_osinergmin.princ, calcular_sc)
proc.time() - ptm

grifos_sc$sc <- sc_vector


```


Hacemos merge con el dataset anterior:

```{r}
grifos_con_sc <- left_join(grifos_coding_clean, 
                           grifos_sc, 
                           c("codigo_de_osinergmin" = "codigo_de_osinergmin.princ")) 


```

Grabamos el dataset para ser usado luego:

```{r}
saveRDS(grifos_con_sc, file = here::here("data","processed","grifos_con_sc.RDS"))
```

