---
title: "Polígonos Thiessen para dataset"
output: 
  html_notebook: 
    code_folding: hide
---

```{r}
library(sf)
library(dismo)
suppressMessages(library(tidyverse))
suppressMessages(library(spatstat))
suppressMessages(library(deldir))
library(sp)
library(leaflet)
source(here::here("R","2.4_funcion-thiessen.R"))
```


Se construirán los polígonos de Thiesen para todo el dataset, así como se identificarán los vecinos y de que dueño y bandera son. Además, se construirán gráficos de los vecinos

Cargamos la base de datos con grifos y ubicaciones:

```{r}
grifos <- readRDS(here::here("data","processed","grifo_coding_clean.rds"))
glimpse(grifos)
```
# Primer intento de sacar los vecinos de manera programática

Usamos la función definida previamente para hallar los vecinos
```{r}
grifos_1 <- grifos %>% 
    select(x = lon, 
           y = lat, 
           codigo_de_osinergmin,
           razon_social,
           ruc,
           direccion,
           distrito,
           bandera)
vec_thiessen <- vecinos_thiessen(grifos_1)
```


Hacemos el join para tener los datos de los grifos, me parece está mal
```{r}
grifos_to_join <- grifos %>% 
    rownames_to_column() %>%
    select(rowname, 
           codigo_de_osinergmin,
           razon_social,
           ruc,
           direccion,
           distrito,
           bandera) %>%
    mutate(rowname = as.integer(rowname))


grifos_con_vecinos <- left_join(
    vec_thiessen,
    grifos_to_join,
    suffix = c(".princ", ".vec"),
    by = c("ind2" = "rowname")
)



```


Revisamos un grifo cercano para ver si está bien codificado:

```{r}
grifos_con_vecinos %>% 
  filter(razon_social.princ == "INVERSIONES MAVU S.A.C.") %>%
  select(ends_with("vec"))
```

Este grifo está ubicado en Cercado en la avenida Venezuela, por lo que la función está haciendo cualquier cosa.

Creo que el error está en los grifos duplicados (que cambiaron de dueño en algún momento). Como trabajo preliminar, 
solo quedarnos con el primero. Luego habrá que limpiar manualmente y definir fechas.


```{r}
grifos_to_join_2 <- grifos %>% 
    distinct(lat,lon, .keep_all = TRUE) %>%
    rownames_to_column() %>%
    select(rowname, 
           codigo_de_osinergmin,
           razon_social,
           ruc,
           direccion,
           distrito,
           bandera) %>%
    mutate(rowname = as.integer(rowname))

grifos_to_join_2 %>% filter(rowname == 90)

vec_thiessen_1 <- grifos_1 %>%
  distinct(x,y, .keep_all = TRUE) %>%
  vecinos_thiessen(.)

vec_thiessen_1 %>%
  filter(razon_social == "INVERSIONES MAVU S.A.C.") 

grifos_con_vecinos_2 <- left_join(
    vec_thiessen_1,
    grifos_to_join_2,
    suffix = c(".princ", ".vec"),
    by = c("ind2" = "rowname")
)

grifos_con_vecinos_2 %>% 
  filter(razon_social.princ == "INVERSIONES MAVU S.A.C.") 

grifos_con_vecinos_2 %>% 
  filter(razon_social.princ == "SERVICENTRO Y AFINES LAS AMERICAS E.I.R.L.") 
```
Ahora sí

# Mapa en google maps
Usamos los siguientes recursos:
- https://stackoverflow.com/questions/43055894/how-to-assign-the-data-of-a-centroid-marker-to-the-voronoi-thiessen-polygon-it
- https://rpubs.com/walkerke/rstudio_gis

Replicando para mi data con el primer link:

```{r}
grifos_puntos <- grifos %>%
  st_as_sf(crs = 4326, coords = c("lon", "lat"))

plot(grifos_puntos["bandera"], key.pos = 1, axes = FALSE,key.width = lcm(1.3), key.length = 1.0)
```

Siguiente:

```{r}
polys <- grifos_puntos %>%
  as("Spatial") %>%
  voronoi() %>%
  st_as_sf() %>%
  st_set_crs(., 4326)

plot(polys["bandera"],key.pos = 1, axes = FALSE,key.width = lcm(1.3), key.length = 1.0)
```


Now, visualize it with Leaflet using your desired colors:

```{r}
pal <- colorFactor("plasma", polys$bandera)


polys %>%
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(fillColor = ~pal(bandera), weight = 0.5, color = "grey") %>%
  addCircleMarkers(data = grifos_puntos, label = ~bandera, color = ~pal(bandera))
```
Todo bien, pero al coger un rectángulo toma área del mar y no tiene sentido. Intentaré arreglar eso

# Corrigiendo los límites (para que no sea una caja y no tome el mar)

Importamos límites de la costa para área de interés (los saqué manualmente):

```{r}
coordenadas_costa <-
    readr::read_csv(here::here("data", "limites_costa.csv"),
                    col_types = c("cc")) %>%
    separate(
        `lat, long`,
        into = c("x", "y"),
        sep = ",",
        convert = TRUE
    )

coordenadas_costa
```


```{r}
require(spatstat)

W <- owin(poly=data.frame(x=rev(coordenadas_costa$x), y=rev(coordenadas_costa$y)))
plot(W)

grifos_coord <- grifos %>% 
    dplyr::select(x = lat, y = lon)

X <- as.ppp(grifos_coord,W=W) 
plot(X) # Just to make sure it looks right. 
dX <- dirichlet(X) 
plot(dX) # Just to make sure ..... 
```


Importamos límites de la costa para área de interés (los saqué manualmente):

```{r}
coordenadas_costa <-
    readr::read_csv(here::here("data", "limites_costa.csv"),
                    col_types = c("cc")) %>%
    separate(
        `lat, long`,
        into = c("y", "x"),
        sep = ",",
        convert = TRUE
    )

coordenadas_costa
```

Creamos un gráfico simple para ver si funciona (ojo primero va la longitud, luego latitud)

```{r}
require(spatstat)

coordenadas_costa[1:19,]
W <- owin(poly=data.frame(x=(coordenadas_costa$x), y=(coordenadas_costa$y)))
plot(W)

grifos_coord <- grifos %>% 
    dplyr::select(x = lon, y = lat)

X <- as.ppp(grifos_coord,W=W) 
plot(X) # Just to make sure it looks right. 
dX <- dirichlet(X) 
plot(dX) # Just to make sure ..... 
```

Ahora lo hacemos en mapa interactivo usando leaflet
```{r}
library(maptools)
dXsp <- as(dX, "SpatialPolygons")

dsp_df <- SpatialPolygonsDataFrame(dXsp, 
                                   data = data.frame(id = 1:length(dXsp@polygons)))

proj4string(dsp_df) <- CRS("+proj=longlat +datum=WGS84")
dsp_xy <- spTransform(dsp_df, CRS("+proj=longlat +datum=WGS84"))


#Nos quedamos solo con los distintos, y agregamos columna de datos de bandera:

grifos_filtrado <- grifos %>% 
  distinct(lat,lon, .keep_all = TRUE) %>%
  rownames_to_column("rowname")

grifos_filtrado

grifos_thissen <- merge(dsp_xy, grifos_filtrado, by.x="id", by.y="rowname")

pal <- colorFactor("plasma", grifos_thissen$bandera)

leaflet() %>%
  addMarkers(data = grifos, 
             lat = ~ lat, 
             lng = ~ lon, 
             popup = grifos$razon_social,
             label = grifos$bandera) %>%
  # addPolygons(data = dsp_xy, 
  #             color = "green", 
  #             fill = "green") %>%
  addPolygons(data = grifos_thissen,
              fillColor = ~pal(bandera), 
              weight = 1, 
              color = "black") %>%
  addTiles()
```

```{r remedy001}

leaflet() %>%

  addPolygons(data = grifos_thissen,
              fillColor = ~pal(bandera), 
              weight = 1, 
              color = "black") %>%
  addTiles()

```

