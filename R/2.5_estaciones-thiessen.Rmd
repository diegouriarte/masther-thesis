---
title: "Polígonos Thiessen para dataset"
output: 
  html_notebook: 
    code_folding: hide
---

```{r}
library(sf)
library(dismo)
suppressMessages(library(tidyverse))
suppressMessages(library(spatstat))
suppressMessages(library(deldir))
library(sp)
library(leaflet)
source(here::here("R","2.4_funcion-thiessen.R"))
```


Se construir?n los pol?gonos de Thiesen para todo el dataset, as? como se identificar?n los vecinos y de que due?o y bandera son. Adem?s, se construir?n gr?ficos de los vecinos

Cargamos la base de datos con grifos y ubicaciones:

```{r}
grifos <- readRDS(here::here("data","processed","grifo_coding_clean.rds"))
glimpse(grifos)
```
<!-- # Primer intento de sacar los vecinos de manera programática -->

<!-- Usamos la función definida previamente para hallar los vecinos -->
<!-- ```{r} -->
<!-- grifos_1 <- grifos %>%  -->
<!--     select(x = lon,  -->
<!--            y = lat,  -->
<!--            codigo_de_osinergmin, -->
<!--            razon_social, -->
<!--            ruc, -->
<!--            direccion, -->
<!--            distrito, -->
<!--            bandera) -->
<!-- vec_thiessen <- vecinos_thiessen(grifos_1) -->
<!-- ``` -->


<!-- Hacemos el join para tener los datos de los grifos, me parece está mal -->
<!-- ```{r} -->
<!-- grifos_to_join <- grifos %>%  -->
<!--     rownames_to_column() %>% -->
<!--     select(rowname,  -->
<!--            codigo_de_osinergmin, -->
<!--            razon_social, -->
<!--            ruc, -->
<!--            direccion, -->
<!--            distrito, -->
<!--            bandera) %>% -->
<!--     mutate(rowname = as.integer(rowname)) -->


<!-- grifos_con_vecinos <- left_join( -->
<!--     vec_thiessen, -->
<!--     grifos_to_join, -->
<!--     suffix = c(".princ", ".vec"), -->
<!--     by = c("ind2" = "rowname") -->
<!-- ) -->



<!-- ``` -->


<!-- Revisamos un grifo cercano para ver si está bien codificado: -->

# ```{r}
# grifos_con_vecinos %>%
#   filter(razon_social.princ == "INVERSIONES MAVU S.A.C.") %>%
#   select(ends_with("vec"))
# ```

<!-- Este grifo est? ubicado en Cercado en la avenida Venezuela, por lo que la funci?n est? haciendo cualquier cosa. -->

<!-- Creo que el error est? en los grifos duplicados (que cambiaron de due?o en alg?n momento). Como trabajo preliminar,  -->
<!-- solo quedarnos con el primero. Luego habr? que limpiar manualmente y definir fechas. -->


# ```{r}
# grifos_to_join_2 <- grifos %>% 
#     distinct(lat,lon, .keep_all = TRUE) %>%
#     rownames_to_column() %>%
#     select(rowname, 
#            codigo_de_osinergmin,
#            razon_social,
#            ruc,
#            direccion,
#            distrito,
#            bandera) %>%
#     mutate(rowname = as.integer(rowname))
# 
# grifos_to_join_2 %>% filter(rowname == 90)
# 
# vec_thiessen_1 <- grifos_1 %>%
#   distinct(x,y, .keep_all = TRUE) %>%
#   vecinos_thiessen(.)
# 
# vec_thiessen_1 %>%
#   filter(razon_social == "INVERSIONES MAVU S.A.C.") 
# 
# grifos_con_vecinos_2 <- left_join(
#     vec_thiessen_1,
#     grifos_to_join_2,
#     suffix = c(".princ", ".vec"),
#     by = c("ind2" = "rowname")
# )
# 
# grifos_con_vecinos_2 %>% 
#   filter(razon_social.princ == "INVERSIONES MAVU S.A.C.") 
# 
# grifos_con_vecinos_2 %>% 
#   filter(razon_social.princ == "SERVICENTRO Y AFINES LAS AMERICAS E.I.R.L.") 
# ```
<!-- Ahora s? -->

Guardemos ese dataset para utilizarlo en otro archivo cuya funcion sea sacar las medidas de concentraci?n y otras cosas divertidas

```{r}
saveRDS(grifos_con_vecinos, file = here::here("data","processed","grifo_con_vecinos.RDS"))
```


# Mapa en google maps - Visualizaci?n

Usamos los siguientes recursos:
- https://stackoverflow.com/questions/43055894/how-to-assign-the-data-of-a-centroid-marker-to-the-voronoi-thiessen-polygon-it
- https://rpubs.com/walkerke/rstudio_gis

Replicando para mi data con el primer link:

```{r}
grifos_puntos <- grifos %>%
  st_as_sf(crs = 4326, coords = c("lon", "lat"))

plot(grifos_puntos["bandera"], key.pos = 1, axes = FALSE,key.width = lcm(1.3), key.length = 1.0)
```

Siguiente:

```{r}
polys <- grifos_puntos %>%
  as("Spatial") %>%
  voronoi() %>%
  st_as_sf() %>%
  st_set_crs(., 4326)

plot(polys["bandera"],key.pos = 1, axes = FALSE,key.width = lcm(1.3), key.length = 1.0)
```


Now, visualize it with Leaflet using your desired colors:

```{r}
pal <- colorFactor("plasma", polys$bandera)


polys %>%
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(fillColor = ~pal(bandera), weight = 0.5, color = "grey") %>%
  addCircleMarkers(data = grifos_puntos, label = ~bandera, color = ~pal(bandera))
```
Todo bien, pero al coger un rectángulo toma área del mar y no tiene sentido. Intentaré arreglar eso

# Corrigiendo los límites (para que no sea una caja y no tome el mar)

Importamos l?mites de la costa para ?rea de inter?s (los saqu? manualmente):

```{r}
coordenadas_costa <-
    readr::read_csv(here::here("data", "limites_costa.csv"),
                    col_types = c("cc")) %>%
    separate(
        `lat, long`,
        into = c("y", "x"),
        sep = ",",
        convert = TRUE
    )


```

Creamos un gr?fico simple para ver si funciona (ojo primero va la longitud, luego latitud)

```{r}
require(spatstat)

W <- owin(poly=data.frame(x=(coordenadas_costa$x), y=(coordenadas_costa$y)))
plot(W)

grifos_coord <- grifos %>% 
    dplyr::select(x = lon, y = lat)

X <- as.ppp(grifos_coord,W=W) 
plot(X) # Just to make sure it looks right. 
dX <- dirichlet(X) 
plot(dX) # Just to make sure ..... 
```

Ahora lo hacemos en mapa interactivo usando leaflet
```{r}
library(maptools)
dXsp <- as(dX, "SpatialPolygons")

dsp_df <- SpatialPolygonsDataFrame(dXsp, 
                                   data = data.frame(id = 1:length(dXsp@polygons)))

proj4string(dsp_df) <- CRS("+proj=longlat +datum=WGS84")
dsp_xy <- spTransform(dsp_df, CRS("+proj=longlat +datum=WGS84"))


#Nos quedamos solo con los distintos, y agregamos columna de datos de bandera:

grifos_filtrado <- grifos %>% 
  distinct(lat,lon, .keep_all = TRUE) %>%
  rownames_to_column("rowname")

grifos_filtrado

grifos_thissen <- merge(dsp_xy, grifos_filtrado, by.x="id", by.y="rowname")

pal <- colorFactor("plasma", unique(grifos_thissen$bandera))
pal2 <- colorFactor(c("white", "red","green", "orange", "blue"), unique(grifos_thissen$bandera))
leaflet() %>%
  addMarkers(data = grifos_filtrado, 
             lat = ~ lat, 
             lng = ~ lon, 
             popup = paste0(grifos$razon_social," ",grifos$codigo_de_osinergmin),
             label = grifos$bandera) %>%
  # addPolygons(data = dsp_xy, 
  #             color = "green", 
  #             fill = "green") %>%
  addPolygons(data = grifos_thissen,
              fillColor = ~pal2(bandera), 
              weight = 1, 
              color = "black") %>%
  addTiles()
```

# Pruebas

```{r}
grifos_thissen$codigo_de_osinergmin
grifos_thissen[grifos_thissen$codigo_de_osinergmin == 15234,]

for (grifo in grifos_thissen$codigo_de_osinergmin) {
  raster::intersect(grifos_thissen[grifos_thissen$codigo_de_osinergmin == 15234,], 
                    grifos_thissen[grifos_thissen$codigo_de_osinergmin == grifo,])
}
raster::intersect(grifos_thissen[grifos_thissen$codigo_de_osinergmin == 7709,], 
                  grifos_thissen[grifos_thissen$codigo_de_osinergmin == 40975,])

rgeos::gIntersection(grifos_thissen[grifos_thissen$codigo_de_osinergmin == 7709,], 
                  grifos_thissen[grifos_thissen$codigo_de_osinergmin == 40975,])

rgeos::gIntersection(grifos_thissen[grifos_thissen$codigo_de_osinergmin == 7709,], 
                  grifos_thissen[grifos_thissen$codigo_de_osinergmin == 9536,])

vec_15234 <- vector()
for (grifo in grifos_thissen$codigo_de_osinergmin) {
  
  t <- rgeos::gIntersection(grifos_thissen[grifos_thissen$codigo_de_osinergmin == 15234,], 
                       grifos_thissen[grifos_thissen$codigo_de_osinergmin == grifo,])
  
  if (!is.null(t)) {
    vec_15234 <- append(vec_15234, grifo)
  }
}
```

```{r}

grifos
hallar_bandera <- function(cod1) {
    # se debe tener cargado el ouput de 2.5 estaciones thiessen
    #input: codigo del grifo
    #ouput: bandera del grifo
  unique(grifos[grifos$codigo_de_osinergmin == cod1, ]$bandera)
    # grifos %>% 
    #     filter(codigo_de_osinergmin == cod1) %>%
    #     distinct(bandera) %>% 
    #     pull()
}

vec_thiessen_irr <- function(cod) {
  #función que devuelve un vector con los vecinos del grifo
  ans <- vector()
  for (grifo in grifos_thissen$codigo_de_osinergmin) {
    
    t <- rgeos::gIntersection(grifos_thissen[grifos_thissen$codigo_de_osinergmin == cod,], 
                              grifos_thissen[grifos_thissen$codigo_de_osinergmin == grifo,])
    
    if (!is.null(t)) {
      ans <- append(ans, grifo)
    }
  }
  bandera <- hallar_bandera(cod)
  tibble("codigo_de_osinergmin.princ" = rep(cod, length(ans)), 
       "codigo_de_osinergmin.vec" = ans) # %>%
    # distinct() %>%
    # mutate(bandera.princ = bandera,
    #        bandera.vec = hallar_bandera(codigo_de_osinergmin.vec))
}


```


```{r}


vec_thiessen_irr(19963)
```

Ahora lo hacemos para toda la muestra:

```{r}
grifos_thiessen_irr <- tibble("codigo_de_osinergmin.princ" =  numeric(), 
       "codigo_de_osinergmin.vec" = numeric())
grifos_thiessen_irr
for (grifo in grifos$codigo_de_osinergmin) {
  
  grifos_thiessen_irr <- bind_rows(grifos_thiessen_irr,
                                   vec_thiessen_irr(grifo) )  
  
  }

grifos_thiessen_irr <- grifos_thiessen_irr %>%
  filter(codigo_de_osinergmin.princ != codigo_de_osinergmin.vec)
```

Ahora agregamos información sobre las banderas:

```{r}
grifos_con_vecinos <- left_join(
  grifos_thiessen_irr,
  select(
    grifos,
    codigo_de_osinergmin,
    bandera.princ = bandera,
    razon_social.princ = razon_social
  ),
  by = c("codigo_de_osinergmin.princ" = "codigo_de_osinergmin")
) %>%
  left_join(
    select(
      grifos,
      codigo_de_osinergmin,
      bandera.vec = bandera,
      razon_social.vec = razon_social
    ),
    by = c("codigo_de_osinergmin.vec" = "codigo_de_osinergmin")
  )
```

```{r}
grifos_con_vecinos %>%
  filter(razon_social.princ == "INVERSIONES MAVU S.A.C.") %>%
  select(ends_with("vec"))
```


```{r}
saveRDS(grifos_con_vecinos, file = here::here("data","processed","grifo_con_vecinos.RDS"))
```