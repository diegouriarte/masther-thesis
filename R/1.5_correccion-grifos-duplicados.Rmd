---
title: "Corrección grifos duplicados"
output: html_notebook
---
```{r}
library(lubridate)
library(stringr)
suppressMessages(library(tidyverse))
prices <- readRDS(here::here("data","processed","data_2005_2018_clean.rds"))
grifos <- readRDS(here::here("data","processed","grifo_coding_raw.rds"))
'%ni%' <- Negate('%in%')
```


Corregerimos los grifos duplicados, ayudandonos con la data de precios y la data geolocalizada.

Primero, todos los grifos que tienen mismo código, más de una entrada, y que no sean de un grifo conocido, esos los trataremos de manera independiente.

```{r}

grifos_repetidos <- grifos %>% 
    filter(!is.na(lat),
           !str_detect(razon_social,"COESTI"),
           !str_detect(razon_social,"REPSOL"),
           !str_detect(razon_social,"PERUANA DE COMB")) %>%
    group_by(codigo_de_osinergmin) %>%
    filter(n()>1) %>%
    ungroup() %>%
    arrange(lat,codigo_de_osinergmin) %>%
    distinct(codigo_de_osinergmin, .keep_all = TRUE)

grifos_sin_marca_repetidos <- grifos %>% 
    filter(!is.na(lat),
           !str_detect(razon_social,"COESTI"),
           !str_detect(razon_social,"REPSOL"),
           !str_detect(razon_social,"PERUANA DE COMB")) %>%
    group_by(codigo_de_osinergmin) %>%
    filter(n()>1) %>%
    ungroup()

grifos_1 <- anti_join(grifos,
                      grifos_sin_marca_repetidos,
                      by = NULL) %>%
    bind_rows(grifos_repetidos)

```

Ahora, `grifos_1` ya no tiene duplicados con el mismo código, al menos para casos sin grifos conocidos. Como hay grifos de PECSA que podrían haber pasado a COESTI, los filtramos y solo vemos duplicados que tengan que ver con Repsol. En caso duplicado, nos quedamos siempre con la razón social de Repsol:

```{r}
grifos_repsol_depurado <- grifos_1 %>%
    filter(!is.na(lat),
           !str_detect(razon_social,"COESTI"),
           !str_detect(razon_social,"PERUANA DE COMB")) %>%
    group_by(codigo_de_osinergmin) %>%
    filter(n() > 1) %>%
    ungroup() %>%
    arrange(codigo_de_osinergmin) %>%
    filter(str_detect(razon_social, "REPSOL")) %>%
    distinct(codigo_de_osinergmin, .keep_all = TRUE)

#filtramos todas las observaciones que 
grifos_repsol_repetidos <- grifos_1 %>%
    filter(!is.na(lat),
           !str_detect(razon_social,"COESTI"),
           !str_detect(razon_social,"PERUANA DE COMB")) %>%
    group_by(codigo_de_osinergmin) %>%
    filter(n() > 1) %>%
    ungroup() %>%
    arrange(codigo_de_osinergmin) 

grifos_2 <- anti_join(grifos_1,
                      grifos_repsol_repetidos,
                      by = NULL) %>%
    bind_rows(grifos_repsol_depurado)


```
Ahora debería haber menos grifos repetidos, verificamos:

```{r}
grifos_coesti_depurado <- grifos_2 %>% 
    filter(!is.na(lat)) %>%
    group_by(codigo_de_osinergmin) %>%
    filter(n()>1) %>%
    ungroup() %>%
    arrange(codigo_de_osinergmin) %>%
    distinct(codigo_de_osinergmin, .keep_all = TRUE)

grifos_coesti_repetido <- grifos_2 %>% 
    filter(!is.na(lat)) %>%
    group_by(codigo_de_osinergmin) %>%
    filter(n()>1) %>%
    ungroup() %>%
    arrange(codigo_de_osinergmin)

grifos_3 <- anti_join(grifos_2,
                      grifos_coesti_repetido,
                      by = NULL) %>%
    bind_rows(grifos_coesti_depurado)
```

```{r}
grifos_3 %>% 
    filter(!is.na(lat)) %>%
    group_by(codigo_de_osinergmin) %>%
    filter(n()>1)
```

Ahora ya no hay duplicados por `codigo_de_osinerming` en la base de datos.

## Verificamos por dirección duplicada

```{r}
grifos_3 %>%
    filter(!is.na(lat)) %>%
    group_by(direccion) %>%
    filter(n()>1)
```
OK, son grifos distintos, de un lado al otro de la avenida.

## Verificamos que no hay grifos con las mismas coordenadas

```{r}
grifos_3 %>%
    filter(!is.na(lat)) %>%
    group_by(lat, lon) %>%
    filter(n()>1) %>%
    arrange(lat, lon) %>%
    ungroup() %>%
    select(codigo_de_osinergmin, razon_social, direccion, distrito, bandera)
```
Debemos tener cuidado con estos, y corregir la base de datos de precios, solo en este caso es necesario, (eliminaremos codigos de osinerming en grifos que son iguales.)

Los grifos 37795 y 132204 en realidad son los mismos (compra de Repsol). Por tanto, con quedamos con el código de Repsol y cambiamos en al base de datos de precios el código 37795 por 132204.


```{r}
prices %>%
    filter(codigo_de_osinergmin == 37795)

prices_1 <- prices %>%
    mutate(codigo_de_osinergmin = as.numeric(codigo_de_osinergmin),
           codigo_de_osinergmin = if_else(codigo_de_osinergmin == 37795, 
                                          132204, 
                                          codigo_de_osinergmin))

prices_1 %>%
    filter(codigo_de_osinergmin == 37795)

#eliminamos de grifos:

grifos_4 <- grifos_3 %>%
    filter(codigo_de_osinergmin != 37795)

grifos_4 %>%
    filter(!is.na(lat)) %>%
    group_by(lat, lon) %>%
    filter(n()>1) %>%
    arrange(lat, lon) %>%
    ungroup() %>%
    select(codigo_de_osinergmin, razon_social, direccion, distrito, bandera)
```
Los grifos 9630 y 128675 en realidad son los mismos cambian de razón social. Nos quedamos con Delta Chocas (128675), por ser el nombre más reciente:

```{r}
prices_1 %>%
    filter(codigo_de_osinergmin == 9630)

prices_2 <- prices_1 %>%
    mutate(codigo_de_osinergmin = as.numeric(codigo_de_osinergmin),
           codigo_de_osinergmin = if_else(codigo_de_osinergmin == 9630, 
                                          128675, 
                                          codigo_de_osinergmin))

prices_2 %>%
    filter(codigo_de_osinergmin == 9630)

#eliminamos de grifos:

grifos_5 <- grifos_4 %>%
    filter(codigo_de_osinergmin != 9630)

grifos_5 %>%
    filter(!is.na(lat)) %>%
    group_by(lat, lon) %>%
    filter(n()>1) %>%
    arrange(lat, lon) %>%
    ungroup() %>%
    select(codigo_de_osinergmin, razon_social, direccion, distrito, bandera)
```


```{r}
prices %>%
    filter(codigo_de_osinergmin %in% c(9630,128675),
           year(fecha_hora) >= 2017) %>%
    ggplot2::ggplot(aes(x = fecha_hora, y = precio_de_venta, color = producto)) +
    ggplot2::geom_point() + 
    ggplot2::facet_wrap(~razon_social)
```
## Verificamos que no hay grifos evidentemente mal codificados con respecto a bandera

Verifiquemso que todos los grifos de Repsol estén bien codificados:

```{r}
grifos_5 %>% 
    filter(str_detect(razon_social,"REPSOL")) %>%
    select(codigo_de_osinergmin,razon_social, direccion, bandera) %>%
    mutate(bandera = str_to_upper(bandera)) %>%
    filter(bandera != "REPSOL")
```


Este es un caso super raro, en el que el grifo físicamente dice Pecsa pero está registrado a nombre de RECOSAC. Cambiaré el nombre de la bandera:

```{r}
grifos_6 <- grifos_5 %>%
    mutate(bandera = if_else(codigo_de_osinergmin == 31927, "REPSOL", bandera))

grifos_6 %>% 
    filter(str_detect(razon_social,"REPSOL")) %>%
    select(codigo_de_osinergmin,razon_social, direccion, bandera) %>%
    mutate(bandera = str_to_upper(bandera)) %>%
    filter(bandera != "REPSOL")
```




Guardamos el file de grifos y precios corregidos:

```{r}

saveRDS(grifos_6,
        file = here::here("data", "processed", "grifo_coding_raw_no_duplicate.rds"))

saveRDS(prices_2, 
        file = here::here("data", "processed", "data_prices_2005_2018_no_duplicates.rds"))

```


