---
title: "Gráfico tendencias precios"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

# Cargamos librerías

```{r}
library(tidyverse)
library(lubridate)
source(here::here("R","funcion05_balancear-panel.R"), encoding = "UTF-8")
'%ni%' <- Negate('%in%')
library(did)
library(ggtext)
library(tidyquant)
'%ni%' <- Negate('%in%')
library(patchwork)

```

# Temas y carga de datos
```{r}
tema_grafica <- theme_bw() + 
  theme(
    panel.spacing.x = unit(0.8, "cm"),
    legend.background = element_blank(),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(colour = "black"),
    # legend.key = element_rect(colour = "black", size = 0.5),
    legend.key = element_blank(), 
    axis.title = element_text(face = "bold"),
    legend.position = "bottom")
 
f_labels <- data.frame(producto = c("G90", "DIESEL"), label = c("", "Venta de Pecsa"))

cols1 <- c(
  "PRIMAX" = "#f1c40f",
  "PECSA"  = "#e74c3c",
  "VECINA" = "#2ecc71",
  "NO VECINA" = "#5a5353"
)

data_total_semanal <- readRDS(file = here::here("data", "processed", "data-final-regresiones_semanal.rds")) %>% 
  mutate(semana_cont = if_else(año == 2017, semana, semana + 53))

data_total_mensual <- readRDS(file = here::here("data", "processed", "data-final-regresiones.rds"))

formato_comun <- list(
  ylim(10, 13),
  # geom_vline(
  #   xintercept = dmy("15/01/2018"),
  #   linetype = "dashed",
  #   size = 0.5, color = "grey55"
  # ),
  geom_rect(data = data.frame(xmin = dmy("01-01-2018"),
                              xmax = dmy("01-02-2018"),
                              ymin = -Inf,
                              ymax = Inf),
            aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
            fill = "grey", alpha = 0.5),
  geom_text(
    x = dmy("01/02/2018"), y = -Inf, vjust = -0.9,
    hjust = -0.1, aes(label = label), data = f_labels,
    color = "grey55", fontface = "bold"
  )
  # scale_color_brewer(palette = "Set1")
)

#' Lista de grifos que son vecinos a estación de PECSA 
#' 

data_total <- data_total_mensual

lista_vecinos_pecsa <- data_total %>% 
  filter(vecino_pecsa_thiessen == 1) %>%
  distinct(codigo_de_osinergmin) %>% 
  pull()

lista_vecinos_primax <- data_total %>% 
  # filter(vecino_primax_thiessen == 1) %>%
  filter(vecino_pecsa_thiessen == 1) %>% 
  distinct(codigo_de_osinergmin) %>% 
  pull()

# lista_vecinos_km <- data_total %>% 
# filter(vecino_pecsa_dist_did == 1) %>%
#   distinct(codigo_de_osinergmin) %>% 
#   pull()

distritos_con_pecsa <- data_total %>% 
  distinct(distrito, tipo_bandera) %>% 
  filter(tipo_bandera == "PROPIA PECSA") %>% 
  pull(distrito)

distritos_con_primax <- data_total %>% 
  distinct(distrito, tipo_bandera) %>% 
  filter(tipo_bandera == "PROPIA PRIMAX") %>% 
  pull(distrito)
```


# Gráfica original

```{r}
data_total_semanal %>% 
    filter(
           codigo_de_osinergmin %ni% lista_vecinos,
           fecha >= dmy("01/07/2017") & fecha <= dmy("01/11/2018")) %>% 
    mutate(producto = fct_relevel(producto,c("G90","DIESEL")),
           pecsa_no = case_when(
             tipo_bandera == "PROPIA PECSA" ~ "PECSA",
             tipo_bandera == "PROPIA PRIMAX" ~ "PRIMAX",
             TRUE ~ "NO VECINOS")) %>% 
    filter(producto == "G90") %>% 
    group_by(fecha, pecsa_no) %>% 
    summarise(precio_promedio = mean(precio_de_venta), .groups = "drop") %>% 
    group_by(pecsa_no) %>% 
    tq_mutate(
        # tq_mutate args
        select     = precio_promedio,
        mutate_fun = rollapply, 
        # rollapply args
        width      = 4,
        align      = "right",
        FUN        = mean,
        # mean args
        na.rm      = TRUE,
        # tq_mutate args
        col_rename = "media_movil"
    ) %>% 
    ggplot() +
    geom_line(aes(x = fecha, y = media_movil, color = pecsa_no),
              size = 1) +
    labs(x = "Fecha", 
         y = "Precio promedio", 
         color = "Estaciones",
         title = "Precios promedio de Gasohol 90") +
    tema_grafica +
    formato_comun + 
    scale_color_manual(values=c("#2ecc71", "#e74c3c", "#f1c40f"))
```

# Gráfica de gasohol
Solo Primax y sus vecinas y no vecinas

```{r}
(p_primax_g90 <- data_total_semanal %>%
  filter(
    fecha >= dmy("01/07/2017") & fecha <= dmy("01/11/2018"),
    tipo_bandera != "PROPIA PECSA",
    tipo_bandera == "PROPIA PRIMAX" | vecino_pecsa_thiessen == 0,
  ) %>%
  mutate(
    primax_no = case_when(
      tipo_bandera == "PROPIA PRIMAX" ~ "PRIMAX",
      vecino_primax_thiessen == 1 ~ "VECINA",
      TRUE ~ "NO VECINA"
    ),
    primax_no = fct_relevel(primax_no, "PRIMAX", "VECINA")
  ) %>%
  filter(producto == "G90") %>%
  group_by(fecha, primax_no) %>%
  summarise(precio_promedio = mean(precio_de_venta), .groups = "drop") %>%
  group_by(primax_no) %>%
  tq_mutate(
    # tq_mutate args
    select = precio_promedio,
    mutate_fun = rollapply,
    # rollapply args
    width = 4,
    align = "right",
    FUN = mean,
    # mean args
    na.rm = TRUE,
    # tq_mutate args
    col_rename = "media_movil"
  ) %>%
  ggplot() +
  geom_line(aes(x = fecha, y = media_movil, color = primax_no),
    size = 1
  ) +
  labs(
    x = NULL,
    y = "Precio promedio (soles / galón)",
    color = "",
    title = "Evolución de precios de Primax"
  ) +
  tema_grafica +
  formato_comun +
  scale_color_manual(values = cols1))
```

```{r}
(p_pecsa_g90 <- data_total_semanal %>%
  filter(
    fecha >= dmy("01/07/2017") & fecha <= dmy("01/11/2018"),
    tipo_bandera != "PROPIA PRIMAX",
    tipo_bandera == "PROPIA PECSA" | vecino_primax_thiessen == 0,
    producto == "G90",
  ) %>%
  mutate(
    pecsa_no = case_when(
      tipo_bandera == "PROPIA PECSA" ~ "PECSA",
      vecino_pecsa_thiessen == 1 ~ "VECINA",
      TRUE ~ "NO VECINA"
    ),
    pecsa_no = fct_relevel(pecsa_no, "PRIMAX", "PECSA", "VECINA")
  ) %>%
  group_by(fecha, pecsa_no) %>%
  summarise(precio_promedio = mean(precio_de_venta), .groups = "drop") %>%
  group_by(pecsa_no) %>%
  tq_mutate(
    # tq_mutate args
    select = precio_promedio,
    mutate_fun = rollapply,
    # rollapply args
    width = 4,
    align = "right",
    FUN = mean,
    # mean args
    na.rm = TRUE,
    # tq_mutate args
    col_rename = "media_movil"
  ) %>%
  ggplot() +
  geom_line(aes(x = fecha, y = media_movil, color = pecsa_no),
    size = 1
  ) +
  labs(
    x = NULL,
    y = NULL,
    color = "",
    title = "Evolución de precios de Pecsa"
  ) +
  tema_grafica +
  formato_comun +
  scale_color_manual(values = cols1))

p_primax_g90 + p_pecsa_g90 
ggsave(filename = "doc/figures/precios-g90-comparacion.png", 
       height = 4, width = 7)

```


# Gráfica de diesel

```{r}
(p_primax_diesel <- data_total_semanal %>%
  filter(
    fecha >= dmy("01/07/2017") & fecha <= dmy("01/11/2018"),
    tipo_bandera != "PROPIA PECSA",
    tipo_bandera == "PROPIA PRIMAX" | vecino_pecsa_thiessen == 0,
  ) %>%
  mutate(
    primax_no = case_when(
      tipo_bandera == "PROPIA PRIMAX" ~ "PRIMAX",
      vecino_primax_thiessen == 1 ~ "VECINA",
      TRUE ~ "NO VECINA"
    ),
    primax_no = fct_relevel(primax_no, "PRIMAX", "VECINA")
  ) %>%
  filter(producto == "DIESEL") %>%
  group_by(fecha, primax_no) %>%
  summarise(precio_promedio = mean(precio_de_venta), .groups = "drop") %>%
  group_by(primax_no) %>%
  tq_mutate(
    # tq_mutate args
    select = precio_promedio,
    mutate_fun = rollapply,
    # rollapply args
    width = 4,
    align = "right",
    FUN = mean,
    # mean args
    na.rm = TRUE,
    # tq_mutate args
    col_rename = "media_movil"
  ) %>%
  ggplot() +
  geom_line(aes(x = fecha, y = media_movil, color = primax_no),
    size = 1
  ) +
  labs(
    x = NULL,
    y = "Precio promedio (soles / galón)",
    color = "",
    title = "Evolución de precios de Primax"
  ) +
  tema_grafica +
  formato_comun +
  scale_color_manual(values = cols1))
```

```{r}
(p_pecsa_diesel <- data_total_semanal %>%
  filter(
    fecha >= dmy("01/07/2017") & fecha <= dmy("01/11/2018"),
    tipo_bandera != "PROPIA PRIMAX",
    tipo_bandera == "PROPIA PECSA" | vecino_primax_thiessen == 0,
    producto == "DIESEL",
  ) %>%
  mutate(
    pecsa_no = case_when(
      tipo_bandera == "PROPIA PECSA" ~ "PECSA",
      vecino_pecsa_thiessen == 1 ~ "VECINA",
      TRUE ~ "NO VECINA"
    ),
    pecsa_no = fct_relevel(pecsa_no, "PRIMAX", "PECSA", "VECINA")
  ) %>%
  group_by(fecha, pecsa_no) %>%
  summarise(precio_promedio = mean(precio_de_venta), .groups = "drop") %>%
  group_by(pecsa_no) %>%
  tq_mutate(
    # tq_mutate args
    select = precio_promedio,
    mutate_fun = rollapply,
    # rollapply args
    width = 4,
    align = "right",
    FUN = mean,
    # mean args
    na.rm = TRUE,
    # tq_mutate args
    col_rename = "media_movil"
  ) %>%
  ggplot() +
  geom_line(aes(x = fecha, y = media_movil, color = pecsa_no),
    size = 1
  ) +
  labs(
    x = NULL,
    y = NULL,
    color = "",
    title = "Evolución de precios de Pecsa"
  ) +
  tema_grafica +
  formato_comun +
  scale_color_manual(values = cols1))

ggsave(filename = "doc/figures/precios-diesel-comparacion.png", 
       height = 4, width = 7)



```